<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LiveCard Studio ‚Äî Create Living Greeting Cards</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,600;0,700;1,400&family=Outfit:wght@300;400;500;600&family=Dancing+Script:wght@400;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root {
  --bg: #0F0E0D;
  --surface: #1A1918;
  --surface2: #242220;
  --border: #333130;
  --border-hover: #4A4745;
  --text: #F0EBE3;
  --text-dim: #9B9590;
  --text-muted: #6B6560;
  --accent: #D4A853;
  --accent-soft: rgba(212,168,83,0.12);
  --accent-glow: rgba(212,168,83,0.25);
  --rose: #C4727F;
  --rose-soft: rgba(196,114,127,0.12);
  --cream: #FDF6EC;
  --radius: 12px;
}

* { margin:0; padding:0; box-sizing:border-box; }

body {
  background: var(--bg);
  color: var(--text);
  font-family: 'Outfit', sans-serif;
  font-weight: 300;
  min-height: 100vh;
  overflow-x: hidden;
}

/* Ambient background */
body::before {
  content:''; position:fixed; inset:0; pointer-events:none; z-index:0;
  background:
    radial-gradient(ellipse at 15% 20%, rgba(212,168,83,0.04) 0%, transparent 50%),
    radial-gradient(ellipse at 85% 80%, rgba(196,114,127,0.03) 0%, transparent 50%),
    radial-gradient(ellipse at 50% 50%, rgba(168,181,160,0.02) 0%, transparent 60%);
}

/* ===== HEADER ===== */
.header {
  position: relative; z-index:2;
  padding: 18px 30px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  border-bottom: 1px solid var(--border);
}
.logo {
  font-family: 'Playfair Display', serif;
  font-size: 1.35rem; font-weight: 600;
  color: var(--accent);
  letter-spacing: 0.5px;
  text-decoration: none;
}
.logo span { color: var(--rose); }

.user-nav {
  display: flex;
  align-items: center;
  gap: 14px;
}
.user-email {
  font-size: 0.78rem;
  color: var(--text-muted);
  max-width: 180px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
.btn-signout {
  font-size: 0.72rem;
  font-weight: 500;
  letter-spacing: 1px;
  text-transform: uppercase;
  color: var(--text-muted);
  background: none;
  border: 1px solid var(--border);
  border-radius: 6px;
  padding: 6px 14px;
  cursor: pointer;
  font-family: 'Outfit', sans-serif;
  transition: all 0.2s;
}
.btn-signout:hover { border-color: var(--border-hover); color: var(--text-dim); }

/* ===== MY CARDS SHELF ===== */
#myCardsSection {
  position: relative; z-index:1;
  max-width: 1100px;
  margin: 0 auto;
  padding: 36px 24px 0;
  display: none;
}
.shelf-heading {
  font-family: 'Playfair Display', serif;
  font-size: 1.15rem;
  color: var(--text);
  margin-bottom: 18px;
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.shelf-heading span { font-size: 0.78rem; color: var(--text-muted); font-family: 'Outfit', sans-serif; }
.shelf-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
  gap: 14px;
  margin-bottom: 36px;
}
.shelf-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 16px 14px 12px;
  position: relative;
  cursor: default;
  transition: border-color 0.2s;
  overflow: hidden;
}
.shelf-card::before {
  content:''; position:absolute; inset:0;
  opacity: 0.15;
  background: var(--card-color, var(--accent));
  pointer-events: none;
}
.shelf-card:hover { border-color: var(--border-hover); }
.shelf-card-icon { font-size: 1.4rem; margin-bottom: 6px; }
.shelf-card-name {
  font-size: 0.82rem;
  font-weight: 500;
  color: var(--text);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.shelf-card-occasion {
  font-size: 0.72rem;
  color: var(--text-muted);
  margin-top: 3px;
  text-transform: capitalize;
}
.shelf-card-del {
  position: absolute;
  top: 8px; right: 8px;
  background: none;
  border: none;
  color: var(--text-muted);
  font-size: 0.75rem;
  cursor: pointer;
  padding: 2px 5px;
  border-radius: 4px;
  opacity: 0;
  transition: opacity 0.2s, color 0.2s;
}
.shelf-card:hover .shelf-card-del { opacity: 1; }
.shelf-card-del:hover { color: var(--rose); }
.shelf-empty {
  color: var(--text-muted);
  font-size: 0.85rem;
  padding: 24px 0;
  text-align: center;
  grid-column: 1 / -1;
}
.shelf-divider {
  border: none;
  border-top: 1px solid var(--border);
  margin: 0 0 40px;
}

/* ===== MAIN LAYOUT ===== */
.app {
  position: relative; z-index:1;
  max-width: 1100px;
  margin: 0 auto;
  padding: 40px 24px 80px;
}

/* ===== STEP NAVIGATION ===== */
.steps-nav {
  display: flex; justify-content: center; gap: 8px;
  margin-bottom: 40px;
}
.step-dot {
  width: 10px; height: 10px; border-radius: 50%;
  background: var(--border);
  transition: all 0.4s ease;
  cursor: pointer;
}
.step-dot.active { background: var(--accent); box-shadow: 0 0 12px var(--accent-glow); transform: scale(1.2); }
.step-dot.completed { background: var(--rose); }

.step-label {
  text-align: center; margin-bottom: 30px;
  font-family: 'Playfair Display', serif;
  font-size: 1.5rem; color: var(--text);
  opacity: 0; animation: fadeIn 0.5s ease forwards;
}
.step-label small {
  display: block; font-family: 'Outfit', sans-serif;
  font-size: 0.8rem; color: var(--text-muted); font-weight: 300;
  letter-spacing: 2px; text-transform: uppercase; margin-top: 6px;
}

/* ===== PANELS ===== */
.panel {
  display: none;
  opacity: 0;
  transform: translateY(15px);
}
.panel.active {
  display: block;
  animation: slideIn 0.4s ease forwards;
}

@keyframes slideIn { to { opacity:1; transform:translateY(0); } }
@keyframes fadeIn { to { opacity:1; } }

/* ===== STEP 1: OCCASION ===== */
.occasion-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 14px;
  max-width: 700px;
  margin: 0 auto;
}
.occasion-card {
  display: flex; flex-direction: column; align-items: center;
  gap: 10px; padding: 24px 16px;
  background: var(--surface);
  border: 1.5px solid var(--border);
  border-radius: var(--radius);
  cursor: pointer;
  transition: all 0.3s ease;
}
.occasion-card:hover {
  border-color: var(--border-hover);
  background: var(--surface2);
  transform: translateY(-2px);
}
.occasion-card.selected {
  border-color: var(--accent);
  background: var(--accent-soft);
  box-shadow: 0 0 20px var(--accent-glow);
}
.occasion-card .icon { font-size: 2rem; }
.occasion-card .label {
  font-size: 0.82rem; font-weight: 400;
  letter-spacing: 1px; text-transform: uppercase;
  color: var(--text-dim);
}
.occasion-card.selected .label { color: var(--accent); }

/* ===== STEP 2: PHOTOS ===== */
.upload-area {
  max-width: 600px; margin: 0 auto;
}
.dropzone {
  border: 2px dashed var(--border);
  border-radius: var(--radius);
  padding: 50px 30px;
  text-align: center;
  cursor: pointer;
  transition: all 0.3s ease;
  background: var(--surface);
}
.dropzone:hover, .dropzone.dragover {
  border-color: var(--accent);
  background: var(--accent-soft);
}
.dropzone-icon { font-size: 2.5rem; margin-bottom: 12px; opacity: 0.7; }
.dropzone-text { color: var(--text-dim); font-size: 0.95rem; }
.dropzone-text strong { color: var(--accent); font-weight: 500; }
.dropzone-sub { font-size: 0.78rem; color: var(--text-muted); margin-top: 6px; }

.photo-previews {
  display: flex; gap: 16px; justify-content: center;
  margin-top: 20px; flex-wrap: wrap;
}
.photo-preview {
  position: relative; width: 160px; height: 160px;
  border-radius: 8px; overflow: hidden;
  border: 2px solid var(--border);
}
.photo-preview img {
  width: 100%; height: 100%; object-fit: cover;
}
.photo-remove {
  position: absolute; top: 6px; right: 6px;
  width: 24px; height: 24px; border-radius: 50%;
  background: rgba(0,0,0,0.7); color: white;
  border: none; cursor: pointer; font-size: 0.75rem;
  display: flex; align-items: center; justify-content: center;
  transition: background 0.2s;
}
.photo-remove:hover { background: var(--rose); }

/* ===== STEP 3: CUSTOMIZE ===== */
.customize-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 24px;
  max-width: 700px;
  margin: 0 auto;
}
.customize-grid.full-width { grid-template-columns: 1fr; }

.form-group { display: flex; flex-direction: column; gap: 6px; }
.form-group label {
  font-size: 0.75rem; font-weight: 500;
  letter-spacing: 2px; text-transform: uppercase;
  color: var(--text-muted);
}
.form-group input, .form-group textarea {
  background: var(--surface);
  border: 1.5px solid var(--border);
  border-radius: 8px;
  padding: 12px 14px;
  color: var(--text);
  font-family: 'Outfit', sans-serif;
  font-size: 0.95rem; font-weight: 300;
  transition: border-color 0.3s;
  outline: none;
  resize: vertical;
}
.form-group input:focus, .form-group textarea:focus {
  border-color: var(--accent);
  box-shadow: 0 0 0 3px var(--accent-soft);
}
.form-group textarea { min-height: 120px; line-height: 1.6; }

/* Theme picker */
.theme-section { margin-top: 10px; }
.theme-section label { margin-bottom: 10px; }
.theme-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
  gap: 12px;
}
.theme-card {
  padding: 14px 10px; text-align: center;
  background: var(--surface);
  border: 1.5px solid var(--border);
  border-radius: 10px;
  cursor: pointer;
  transition: all 0.3s ease;
}
.theme-card:hover { border-color: var(--border-hover); transform: translateY(-1px); }
.theme-card.selected {
  border-color: var(--accent);
  background: var(--accent-soft);
  box-shadow: 0 0 15px var(--accent-glow);
}
.theme-dots {
  display: flex; gap: 4px; justify-content: center; margin-bottom: 8px;
}
.theme-dots span {
  width: 14px; height: 14px; border-radius: 50%;
  display: inline-block;
}
.theme-name {
  font-size: 0.75rem; font-weight: 400;
  letter-spacing: 1px; text-transform: uppercase;
  color: var(--text-dim);
}
.theme-card.selected .theme-name { color: var(--accent); }

/* ===== STEP 4: PREVIEW / DOWNLOAD ===== */
.preview-section {
  text-align: center;
  max-width: 700px;
  margin: 0 auto;
}
.preview-frame {
  width: 100%;
  height: 500px;
  border: 1.5px solid var(--border);
  border-radius: var(--radius);
  overflow: hidden;
  background: var(--cream);
  margin-bottom: 24px;
}
.preview-frame iframe {
  width: 100%; height: 100%; border: none;
}

.action-buttons {
  display: flex; gap: 14px; justify-content: center; flex-wrap: wrap;
}

/* ===== BUTTONS ===== */
.btn {
  display: inline-flex; align-items: center; gap: 8px;
  padding: 12px 28px;
  border-radius: 8px;
  font-family: 'Outfit', sans-serif;
  font-size: 0.85rem; font-weight: 500;
  letter-spacing: 1px; text-transform: uppercase;
  cursor: pointer;
  transition: all 0.3s ease;
  border: none;
}
.btn-primary {
  background: var(--accent);
  color: var(--bg);
}
.btn-primary:hover {
  background: #E0B860;
  box-shadow: 0 4px 20px var(--accent-glow);
  transform: translateY(-1px);
}
.btn-secondary {
  background: transparent;
  border: 1.5px solid var(--border);
  color: var(--text-dim);
}
.btn-secondary:hover {
  border-color: var(--text-dim);
  color: var(--text);
}
.btn-rose {
  background: var(--rose);
  color: white;
}
.btn-rose:hover {
  background: #D4828E;
  box-shadow: 0 4px 20px var(--rose-soft);
}

.btn-nav {
  display: flex; justify-content: space-between; align-items: center;
  max-width: 700px; margin: 30px auto 0;
}

/* Toast */
.toast {
  position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(20px);
  background: var(--surface2); color: var(--accent);
  padding: 12px 24px; border-radius: 8px;
  border: 1px solid var(--accent);
  font-size: 0.85rem; font-weight: 400;
  box-shadow: 0 8px 30px rgba(0,0,0,0.4);
  opacity: 0; transition: all 0.4s ease; z-index: 100;
  pointer-events: none;
}
.toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

/* Responsive */
@media (max-width: 600px) {
  .customize-grid { grid-template-columns: 1fr; }
  .occasion-grid { grid-template-columns: repeat(3, 1fr); }
  .header { padding: 14px 16px; }
  .logo { font-size: 1.15rem; }
  .user-email { display: none; }
  .step-label { font-size: 1.2rem; }
  .preview-frame { height: 400px; }
}
</style>
</head>
<body>

<div class="header">
  <a href="/" class="logo">Live<span>Card</span> Studio</a>
  <div class="user-nav">
    <span class="user-email" id="userEmail"></span>
    <button class="btn-signout" onclick="signOut()">Sign Out</button>
  </div>
</div>

<!-- My Cards shelf (visible once signed in) -->
<div id="myCardsSection">
  <div class="shelf-heading">
    My Cards
    <span id="cardCount"></span>
  </div>
  <div class="shelf-grid" id="shelfGrid"></div>
  <hr class="shelf-divider">
</div>

<div class="app">
  <!-- Step dots -->
  <div class="steps-nav">
    <div class="step-dot active" data-step="1"></div>
    <div class="step-dot" data-step="2"></div>
    <div class="step-dot" data-step="3"></div>
    <div class="step-dot" data-step="4"></div>
  </div>

  <!-- STEP 1: OCCASION -->
  <div class="panel active" id="step1">
    <div class="step-label">What's the occasion? <small>Choose a card type</small></div>
    <div class="occasion-grid">
      <div class="occasion-card" data-occasion="birthday">
        <span class="icon">&#127874;</span>
        <span class="label">Birthday</span>
      </div>
      <div class="occasion-card" data-occasion="wedding">
        <span class="icon">&#128141;</span>
        <span class="label">Wedding</span>
      </div>
      <div class="occasion-card" data-occasion="baby">
        <span class="icon">&#128118;</span>
        <span class="label">New Baby</span>
      </div>
      <div class="occasion-card" data-occasion="thankyou">
        <span class="icon">&#128156;</span>
        <span class="label">Thank You</span>
      </div>
      <div class="occasion-card" data-occasion="holiday">
        <span class="icon">&#127876;</span>
        <span class="label">Holiday</span>
      </div>
      <div class="occasion-card" data-occasion="anniversary">
        <span class="icon">&#10024;</span>
        <span class="label">Anniversary</span>
      </div>
      <div class="occasion-card" data-occasion="getwell">
        <span class="icon">&#127804;</span>
        <span class="label">Get Well</span>
      </div>
      <div class="occasion-card" data-occasion="congrats">
        <span class="icon">&#127881;</span>
        <span class="label">Congrats</span>
      </div>
    </div>
    <div class="btn-nav"><div></div><button class="btn btn-primary" id="next1">Continue &#8594;</button></div>
  </div>

  <!-- STEP 2: PHOTOS -->
  <div class="panel" id="step2">
    <div class="step-label">Add Your Photos <small>Upload 1-2 photos for your card</small></div>
    <div class="upload-area">
      <div class="dropzone" id="dropzone">
        <div class="dropzone-icon">&#128247;</div>
        <div class="dropzone-text">Drag photos here or <strong>click to browse</strong></div>
        <div class="dropzone-sub">JPG or PNG &middot; Up to 2 photos &middot; Max 5MB each</div>
        <input type="file" id="fileInput" accept="image/jpeg,image/png" multiple hidden>
      </div>
      <div class="photo-previews" id="photoPreviews"></div>
    </div>
    <div class="btn-nav">
      <button class="btn btn-secondary" id="back2">&#8592; Back</button>
      <button class="btn btn-primary" id="next2">Continue &#8594;</button>
    </div>
  </div>

  <!-- STEP 3: CUSTOMIZE -->
  <div class="panel" id="step3">
    <div class="step-label">Make It Yours <small>Personalize the message & style</small></div>
    <div class="customize-grid">
      <div class="form-group">
        <label>Recipient Name</label>
        <input type="text" id="recipientName" placeholder="e.g. Grandma Sylvia">
      </div>
      <div class="form-group">
        <label>Your Name</label>
        <input type="text" id="senderName" placeholder="e.g. With love, Sarah">
      </div>
    </div>
    <div class="customize-grid full-width" style="margin-top:18px;">
      <div class="form-group">
        <label>Your Message</label>
        <textarea id="messageText" placeholder="Write something beautiful..."></textarea>
      </div>
    </div>
    <div class="customize-grid full-width theme-section" style="margin-top:18px;">
      <div class="form-group">
        <label>Card Theme</label>
        <div class="theme-grid">
          <div class="theme-card selected" data-theme="watercolor">
            <div class="theme-dots">
              <span style="background:#E8A0B4"></span>
              <span style="background:#C9B8D9"></span>
              <span style="background:#A8B5A0"></span>
              <span style="background:#F0C5A8"></span>
            </div>
            <div class="theme-name">Watercolor Garden</div>
          </div>
          <div class="theme-card" data-theme="starlit">
            <div class="theme-dots">
              <span style="background:#1B2540"></span>
              <span style="background:#D4A853"></span>
              <span style="background:#8BA4C4"></span>
              <span style="background:#C9C0D9"></span>
            </div>
            <div class="theme-name">Starlit Night</div>
          </div>
          <div class="theme-card" data-theme="golden">
            <div class="theme-dots">
              <span style="background:#D4A853"></span>
              <span style="background:#E8C080"></span>
              <span style="background:#C47850"></span>
              <span style="background:#F5E6D0"></span>
            </div>
            <div class="theme-name">Golden Hour</div>
          </div>
          <div class="theme-card" data-theme="blossom">
            <div class="theme-dots">
              <span style="background:#F4B4C8"></span>
              <span style="background:#FCDCE8"></span>
              <span style="background:#98C9A3"></span>
              <span style="background:#FFF5F7"></span>
            </div>
            <div class="theme-name">Cherry Blossom</div>
          </div>
        </div>
      </div>
    </div>
    <div class="btn-nav">
      <button class="btn btn-secondary" id="back3">&#8592; Back</button>
      <button class="btn btn-primary" id="next3">Preview Card &#8594;</button>
    </div>
  </div>

  <!-- STEP 4: PREVIEW & DOWNLOAD -->
  <div class="panel" id="step4">
    <div class="step-label">Your Living Card <small>Preview, download &amp; share</small></div>
    <div class="preview-section">
      <div class="preview-frame" id="previewFrame"></div>
      <div class="action-buttons">
        <button class="btn btn-primary" id="btnDownload">&#11015; Download Card</button>
        <button class="btn btn-rose" id="btnCopy">&#128279; Copy Share Link</button>
        <button class="btn btn-secondary" id="back4">&#8592; Edit</button>
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ================================================================
// SUPABASE AUTH
// ================================================================
var SUPABASE_URL  = 'YOUR_SUPABASE_URL';
var SUPABASE_ANON = 'YOUR_ANON_KEY';
var sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);
var currentUser = null;

// Auth guard ‚Äî redirect to login if no session
sb.auth.onAuthStateChange(function(event, session) {
  if (!session) {
    window.location.href = '/login.html';
  } else {
    currentUser = session.user;
    initDashboard(session.user);
  }
});

function initDashboard(user) {
  var emailEl = document.getElementById('userEmail');
  if (emailEl) emailEl.textContent = user.email;
  loadCards();
}

function signOut() {
  sb.auth.signOut().then(function() {
    window.location.href = '/login.html';
  });
}

// ‚îÄ‚îÄ My Cards shelf ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
var occasionIcons = {
  birthday:'üéÇ', wedding:'üíç', baby:'üçº', thankyou:'üíõ',
  holiday:'‚ú®', anniversary:'üåπ', getwell:'üíê', congrats:'üéâ'
};
var themeColors = {
  watercolor:'#C9B8D9', starlit:'#8BB8D8', golden:'#D4A853', blossom:'#C4727F'
};

function loadCards() {
  if (!currentUser) return;
  sb.from('cards').select('*').eq('user_id', currentUser.id).order('created_at', { ascending: false }).then(function(res) {
    var section = document.getElementById('myCardsSection');
    var grid = document.getElementById('shelfGrid');
    var countEl = document.getElementById('cardCount');
    if (res.error || !res.data || res.data.length === 0) {
      if (section) section.style.display = 'none';
      return;
    }
    section.style.display = 'block';
    countEl.textContent = res.data.length + ' card' + (res.data.length !== 1 ? 's' : '');
    grid.innerHTML = '';
    res.data.forEach(function(card) {
      var col = themeColors[card.theme] || themeColors.watercolor;
      var icon = occasionIcons[card.occasion] || 'üíå';
      var el = document.createElement('div');
      el.className = 'shelf-card';
      el.style.setProperty('--card-color', col);
      el.innerHTML =
        '<button class="shelf-card-del" title="Delete" onclick="deleteCard(\'' + card.id + '\',event)">‚úï</button>' +
        '<div class="shelf-card-icon">' + icon + '</div>' +
        '<div class="shelf-card-name">' + escHtml(card.recipient_name || 'Someone Special') + '</div>' +
        '<div class="shelf-card-occasion">' + escHtml(card.occasion || '') + ' ¬∑ ' + escHtml(card.theme || '') + '</div>';
      grid.appendChild(el);
    });
  });
}

function deleteCard(id, e) {
  e.stopPropagation();
  if (!confirm('Delete this card?')) return;
  sb.from('cards').delete().eq('id', id).then(function() { loadCards(); });
}

function saveCardToDB() {
  if (!currentUser) return;
  var payload = {
    user_id:        currentUser.id,
    occasion:       state.occasion,
    recipient_name: state.recipientName || 'Someone Special',
    sender_name:    state.senderName,
    message:        state.message,
    theme:          state.theme,
    photos:         JSON.stringify(state.photos.map(function(p) { return p.dataUrl; }))
  };
  sb.from('cards').insert(payload).then(function() { loadCards(); });
}

function escHtml(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

// ================================================================
// APP STATE
// ================================================================
var state = {
  step: 1,
  occasion: '',
  photos: [],       // {dataUrl, name}
  recipientName: '',
  senderName: '',
  message: '',
  theme: 'watercolor'
};

// Default messages per occasion
var defaultMessages = {
  birthday: "Wishing you a day painted with joy,\nwarmth, and all the colors of happiness.\n\nMay this year bring you\nbeautiful new brushstrokes\non the canvas of your life.",
  wedding: "Two hearts, one beautiful story.\n\nMay your love be a masterpiece\nthat grows more exquisite\nwith every passing year.",
  baby: "Welcome to the world, little one.\n\nYou are the most beautiful\nwork of art we've ever seen.\nThe world is brighter\nnow that you're here.",
  thankyou: "Some people make the world\nmore beautiful just by being in it.\n\nThank you for being one of them.\nYour kindness is a gift\nI carry with me always.",
  holiday: "Wishing you a season\nfilled with warmth, wonder,\nand moments that shimmer\nlike the most beautiful painting.\n\nMay the new year bring\nfresh colors to your world.",
  anniversary: "Year after year,\nyour love paints something\nmore beautiful than the last.\n\nHere's to the masterpiece\nyou continue to create together.",
  getwell: "Sending you gentle colors\nof warmth and healing.\n\nMay each day bring you\na little more brightness,\na little more strength,\nand the comfort of knowing\nyou are deeply loved.",
  congrats: "What an incredible moment!\n\nYou've painted something\ntruly extraordinary,\nand the world is\nmore beautiful for it.\n\nCheers to you and\nall that's ahead."
};

var defaultSubtitles = {
  birthday: 'wishing a very special',
  wedding: 'celebrating the love of',
  baby: 'welcoming with love',
  thankyou: 'with heartfelt gratitude for',
  holiday: 'warm wishes for',
  anniversary: 'celebrating the love of',
  getwell: 'sending healing thoughts to',
  congrats: 'so proud of'
};

var defaultTitles = {
  birthday: 'Happy Birthday',
  wedding: 'Congratulations',
  baby: 'Welcome Little One',
  thankyou: 'Thank You',
  holiday: 'Happy Holidays',
  anniversary: 'Happy Anniversary',
  getwell: 'Get Well Soon',
  congrats: 'Congratulations'
};

// ================================================================
// THEME DEFINITIONS
// ================================================================
var themes = {
  watercolor: {
    bg: '#FDF6EC',
    textColor: '#8B6F5C',
    accentColor: '#C4727F',
    goldColor: '#D4A853',
    borderTop: 'linear-gradient(90deg, transparent, #E8A0B4, #C9B8D9, #A8B5A0, transparent)',
    borderBot: 'linear-gradient(90deg, transparent, #F0C5A8, #D4A853, #E8A0B4, transparent)',
    blobs: [
      {r:232,g:160,b:180,a:0.06},{r:201,g:184,b:217,a:0.05},{r:168,g:181,b:160,a:0.05},
      {r:240,g:197,b:168,a:0.055},{r:212,g:168,b:83,a:0.035},{r:196,g:180,b:200,a:0.04},
      {r:180,g:210,b:200,a:0.04},{r:220,g:170,b:190,a:0.045},{r:190,g:200,b:180,a:0.035}
    ],
    petals: ['rgba(232,160,180,','rgba(201,184,217,','rgba(212,168,83,','rgba(240,197,168,','rgba(168,181,160,','rgba(196,114,127,'],
    petalShape: 'petal',
    frame: 'linear-gradient(145deg,#D4A853,#E8C97A,#B8903E,#D4A853,#E8C97A)',
    frameInner: '#F5EDE0',
    badgeColors: ['#C4727F','#8B6F5C','#5B8FAF','#A09888','#E8467C','#6B7F62','#9B7CB8','#B8903E']
  },
  starlit: {
    bg: '#0C1225',
    textColor: '#C8C0D8',
    accentColor: '#D4A853',
    goldColor: '#8BA4C4',
    borderTop: 'linear-gradient(90deg, transparent, #D4A853, #8BA4C4, #D4A853, transparent)',
    borderBot: 'linear-gradient(90deg, transparent, #8BA4C4, #C9C0D9, #D4A853, transparent)',
    blobs: [
      {r:30,g:50,b:100,a:0.08},{r:80,g:100,b:160,a:0.05},{r:100,g:80,b:140,a:0.04},
      {r:212,g:168,b:83,a:0.025},{r:60,g:80,b:130,a:0.06},{r:140,g:130,b:180,a:0.035},
      {r:50,g:70,b:120,a:0.05},{r:90,g:110,b:160,a:0.04},{r:70,g:60,b:110,a:0.045}
    ],
    petals: ['rgba(212,168,83,','rgba(200,200,230,','rgba(140,170,210,','rgba(180,170,210,','rgba(255,230,160,','rgba(160,180,220,'],
    petalShape: 'circle',
    frame: 'linear-gradient(145deg,#3A3550,#4A4565,#2A2540,#3A3550,#4A4565)',
    frameInner: '#1A1830',
    badgeColors: ['#D4A853','#6B80A0','#8B7AB0','#A09888','#C4A050','#708090','#9B7CB8','#B8903E']
  },
  golden: {
    bg: '#FBF5EA',
    textColor: '#7A5C40',
    accentColor: '#C47850',
    goldColor: '#D4A853',
    borderTop: 'linear-gradient(90deg, transparent, #D4A853, #E8C080, #C47850, transparent)',
    borderBot: 'linear-gradient(90deg, transparent, #C47850, #D4A853, #E8C080, transparent)',
    blobs: [
      {r:212,g:168,b:83,a:0.06},{r:232,g:192,b:128,a:0.05},{r:196,g:120,b:80,a:0.04},
      {r:245,g:230,b:208,a:0.06},{r:220,g:180,b:100,a:0.04},{r:200,g:150,b:100,a:0.035},
      {r:240,g:210,b:160,a:0.045},{r:180,g:140,b:90,a:0.03},{r:230,g:200,b:140,a:0.04}
    ],
    petals: ['rgba(212,168,83,','rgba(232,192,128,','rgba(196,120,80,','rgba(245,230,208,','rgba(220,180,100,','rgba(200,160,110,'],
    petalShape: 'circle',
    frame: 'linear-gradient(145deg,#D4A853,#E8C97A,#B8903E,#D4A853,#E8C97A)',
    frameInner: '#F8F0E0',
    badgeColors: ['#C47850','#8B6F5C','#B8903E','#A09060','#D4A853','#907050','#C49060','#8B7040']
  },
  blossom: {
    bg: '#FFF8FA',
    textColor: '#8B6070',
    accentColor: '#D4829A',
    goldColor: '#98C9A3',
    borderTop: 'linear-gradient(90deg, transparent, #F4B4C8, #98C9A3, #FCDCE8, transparent)',
    borderBot: 'linear-gradient(90deg, transparent, #98C9A3, #F4B4C8, #FCDCE8, transparent)',
    blobs: [
      {r:244,g:180,b:200,a:0.06},{r:252,g:220,b:232,a:0.05},{r:152,g:201,b:163,a:0.04},
      {r:255,g:240,b:245,a:0.05},{r:230,g:170,b:190,a:0.045},{r:180,g:220,b:190,a:0.035},
      {r:250,g:200,b:215,a:0.04},{r:170,g:210,b:180,a:0.03},{r:240,g:190,b:205,a:0.04}
    ],
    petals: ['rgba(244,180,200,','rgba(252,220,232,','rgba(255,200,215,','rgba(230,170,190,','rgba(152,201,163,','rgba(250,190,210,'],
    petalShape: 'petal',
    frame: 'linear-gradient(145deg,#E8C0D0,#F0D0E0,#D0A8B8,#E8C0D0,#F0D0E0)',
    frameInner: '#FFF5F7',
    badgeColors: ['#D4829A','#98C9A3','#B08898','#A0B8A8','#E890A8','#80B090','#C090B0','#A8C0A0']
  }
};

// ================================================================
// STEP NAVIGATION
// ================================================================
function goToStep(n) {
  state.step = n;
  document.querySelectorAll('.panel').forEach(function(p) { p.classList.remove('active'); });
  document.getElementById('step' + n).classList.add('active');
  document.querySelectorAll('.step-dot').forEach(function(d, i) {
    d.classList.remove('active','completed');
    if (i + 1 === n) d.classList.add('active');
    else if (i + 1 < n) d.classList.add('completed');
  });
  if (n === 4) generatePreview();
  window.scrollTo({top: 0, behavior: 'smooth'});
}

// Step dots click
document.querySelectorAll('.step-dot').forEach(function(d) {
  d.addEventListener('click', function() {
    var s = parseInt(this.dataset.step);
    if (s <= state.step || s === state.step + 1) goToStep(s);
  });
});

// Nav buttons
document.getElementById('next1').addEventListener('click', function() { if (state.occasion) goToStep(2); else showToast('Please choose an occasion'); });
document.getElementById('next2').addEventListener('click', function() { if (state.photos.length > 0) goToStep(3); else showToast('Please upload at least one photo'); });
document.getElementById('next3').addEventListener('click', function() {
  state.recipientName = document.getElementById('recipientName').value || 'Someone Special';
  state.senderName = document.getElementById('senderName').value || 'With love';
  state.message = document.getElementById('messageText').value || defaultMessages[state.occasion] || defaultMessages.birthday;
  goToStep(4);
});
document.getElementById('back2').addEventListener('click', function() { goToStep(1); });
document.getElementById('back3').addEventListener('click', function() { goToStep(2); });
document.getElementById('back4').addEventListener('click', function() { goToStep(3); });

// ================================================================
// OCCASION SELECTION
// ================================================================
document.querySelectorAll('.occasion-card').forEach(function(card) {
  card.addEventListener('click', function() {
    document.querySelectorAll('.occasion-card').forEach(function(c) { c.classList.remove('selected'); });
    this.classList.add('selected');
    state.occasion = this.dataset.occasion;
    // Set default message
    document.getElementById('messageText').value = defaultMessages[state.occasion] || '';
  });
});

// ================================================================
// PHOTO UPLOAD
// ================================================================
var dropzone = document.getElementById('dropzone');
var fileInput = document.getElementById('fileInput');

dropzone.addEventListener('click', function() { fileInput.click(); });
dropzone.addEventListener('dragover', function(e) { e.preventDefault(); this.classList.add('dragover'); });
dropzone.addEventListener('dragleave', function() { this.classList.remove('dragover'); });
dropzone.addEventListener('drop', function(e) {
  e.preventDefault(); this.classList.remove('dragover');
  handleFiles(e.dataTransfer.files);
});
fileInput.addEventListener('change', function() { handleFiles(this.files); this.value = ''; });

function handleFiles(files) {
  for (var i = 0; i < files.length && state.photos.length < 2; i++) {
    var file = files[i];
    if (!file.type.match('image.*')) continue;
    if (file.size > 5 * 1024 * 1024) { showToast('File too large (max 5MB)'); continue; }
    (function(f) {
      var reader = new FileReader();
      reader.onload = function(e) {
        // Resize for embedding
        var img = new Image();
        img.onload = function() {
          var canvas = document.createElement('canvas');
          var max = 700;
          var w = img.width, h = img.height;
          if (w > max || h > max) {
            if (w > h) { h = h * max / w; w = max; }
            else { w = w * max / h; h = max; }
          }
          canvas.width = w; canvas.height = h;
          var ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, w, h);
          var dataUrl = canvas.toDataURL('image/jpeg', 0.85);
          state.photos.push({ dataUrl: dataUrl, name: f.name });
          renderPreviews();
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(f);
    })(file);
  }
}

function renderPreviews() {
  var container = document.getElementById('photoPreviews');
  container.innerHTML = '';
  state.photos.forEach(function(p, i) {
    var div = document.createElement('div');
    div.className = 'photo-preview';
    div.innerHTML = '<img src="' + p.dataUrl + '"><button class="photo-remove" data-idx="' + i + '">&times;</button>';
    container.appendChild(div);
  });
  container.querySelectorAll('.photo-remove').forEach(function(btn) {
    btn.addEventListener('click', function(e) {
      e.stopPropagation();
      state.photos.splice(parseInt(this.dataset.idx), 1);
      renderPreviews();
    });
  });
}

// ================================================================
// THEME SELECTION
// ================================================================
document.querySelectorAll('.theme-card').forEach(function(card) {
  card.addEventListener('click', function() {
    document.querySelectorAll('.theme-card').forEach(function(c) { c.classList.remove('selected'); });
    this.classList.add('selected');
    state.theme = this.dataset.theme;
  });
});

// ================================================================
// TOAST
// ================================================================
function showToast(msg) {
  var t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(function() { t.classList.remove('show'); }, 2500);
}

// ================================================================
// CARD GENERATOR ‚Äî builds standalone HTML
// ================================================================
function generateCardHTML() {
  var T = themes[state.theme];
  var occasion = state.occasion || 'birthday';
  var subtitle = defaultSubtitles[occasion] || 'wishing a very special';
  var title = defaultTitles[occasion] || 'Happy Birthday';
  var recipient = state.recipientName || 'Someone Special';
  var sender = state.senderName || 'With love';
  var message = (state.message || defaultMessages[occasion] || '').replace(/\n/g, '<br>');
  var isDark = state.theme === 'starlit';

  // Photo tags
  var photoHTML = '';
  state.photos.forEach(function(p, i) {
    photoHTML += '<div class="painting filter-none" id="painting' + (i+1) + '">' +
      '<span class="style-badge" id="badge' + (i+1) + '"></span>' +
      '<div class="frame"><div class="frame-inner"><div class="img-wrapper">' +
      '<img src="' + p.dataUrl + '" alt="Photo">' +
      '</div></div></div>' +
      '<p class="painting-label">' + (state.photos.length > 1 ? (i === 0 ? 'I' : 'II') : '') + '</p></div>';
  });

  var blobsJS = 'var blobDefs = ' + JSON.stringify(T.blobs) + ';';
  var petalsJS = 'var petalColors = ' + JSON.stringify(T.petals) + ';';
  var petalShape = T.petalShape;
  var badgeColorsJS = JSON.stringify(T.badgeColors);

  return '<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8">' +
    '<meta name="viewport" content="width=device-width,initial-scale=1.0">' +
    '<title>A Card For ' + recipient + '</title>' +
    '<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400;1,700&family=Cormorant+Garamond:ital,wght@0,300;0,400;1,300;1,400&family=Dancing+Script:wght@400;700&display=swap" rel="stylesheet">' +
    '<svg style="position:absolute;width:0;height:0"><defs>' +
    '<filter id="oil-painting" x="-5%" y="-5%" width="110%" height="110%"><feTurbulence type="turbulence" baseFrequency="0.015 0.02" numOctaves="3" seed="2" result="t"/><feDisplacementMap in="SourceGraphic" in2="t" scale="6" xChannelSelector="R" yChannelSelector="G" result="d"/><feGaussianBlur in="d" stdDeviation="0.8" result="s"/><feColorMatrix in="s" type="saturate" values="1.4"/></filter>' +
    '<filter id="watercolor" x="-5%" y="-5%" width="110%" height="110%"><feTurbulence type="turbulence" baseFrequency="0.008 0.012" numOctaves="4" seed="5" result="t"/><feDisplacementMap in="SourceGraphic" in2="t" scale="14" xChannelSelector="R" yChannelSelector="G" result="d"/><feGaussianBlur in="d" stdDeviation="1.8" result="b"/><feColorMatrix in="b" type="saturate" values="1.5" result="sat"/><feComponentTransfer in="sat"><feFuncR type="linear" slope="0.95" intercept="0.08"/><feFuncG type="linear" slope="0.93" intercept="0.07"/><feFuncB type="linear" slope="0.88" intercept="0.06"/></feComponentTransfer></filter>' +
    '<filter id="pencil-sketch" x="-2%" y="-2%" width="104%" height="104%"><feColorMatrix type="matrix" values="0.33 0.33 0.33 0 0 0.33 0.33 0.33 0 0 0.33 0.33 0.33 0 0 0 0 0 1 0" result="gray"/><feComponentTransfer in="gray" result="cg"><feFuncR type="linear" slope="1.8" intercept="-0.3"/><feFuncG type="linear" slope="1.8" intercept="-0.3"/><feFuncB type="linear" slope="1.8" intercept="-0.3"/></feComponentTransfer><feConvolveMatrix in="gray" order="3" kernelMatrix="-1 -1 -1 -1 8 -1 -1 -1 -1" preserveAlpha="true" result="edges"/><feComponentTransfer in="edges" result="inv"><feFuncR type="table" tableValues="1 0"/><feFuncG type="table" tableValues="1 0"/><feFuncB type="table" tableValues="1 0"/></feComponentTransfer><feComponentTransfer in="inv" result="dk"><feFuncR type="linear" slope="5" intercept="-2"/><feFuncG type="linear" slope="5" intercept="-2"/><feFuncB type="linear" slope="5" intercept="-2"/></feComponentTransfer><feBlend in="cg" in2="dk" mode="multiply" result="sketch"/><feColorMatrix in="sketch" type="matrix" values="1 .02 0 0 .04 0 .97 .02 0 .03 0 0 .86 0 0 0 0 0 1 0"/></filter>' +
    '<filter id="pop-art"><feComponentTransfer result="p"><feFuncR type="discrete" tableValues="0 .15 .35 .55 .8 1"/><feFuncG type="discrete" tableValues="0 .15 .35 .55 .8 1"/><feFuncB type="discrete" tableValues="0 .15 .35 .55 .8 1"/></feComponentTransfer><feColorMatrix in="p" type="saturate" values="2.5" result="s"/><feComponentTransfer in="s"><feFuncR type="linear" slope="1.3" intercept="-0.05"/><feFuncG type="linear" slope="1.3" intercept="-0.05"/><feFuncB type="linear" slope="1.3" intercept="-0.05"/></feComponentTransfer></filter>' +
    '<filter id="dreamy" x="-5%" y="-5%" width="110%" height="110%"><feGaussianBlur in="SourceGraphic" stdDeviation="6" result="b"/><feComponentTransfer in="b" result="bb"><feFuncR type="linear" slope="1.3" intercept="0.05"/><feFuncG type="linear" slope="1.25" intercept="0.04"/><feFuncB type="linear" slope="1.35" intercept="0.06"/></feComponentTransfer><feBlend in="SourceGraphic" in2="bb" mode="screen" result="g"/><feColorMatrix in="g" type="matrix" values=".95 .05 .05 0 .02 .03 .9 .05 0 .01 .05 .08 .95 0 .04 0 0 0 1 0" result="t"/><feColorMatrix in="t" type="saturate" values="0.8"/></filter>' +
    '<filter id="vintage" x="-5%" y="-5%" width="110%" height="110%"><feColorMatrix type="matrix" values=".55 .35 .15 0 .03 .25 .50 .15 0 .02 .15 .25 .40 0 0 0 0 0 1 0" result="s"/><feTurbulence type="fractalNoise" baseFrequency="0.5" numOctaves="3" seed="3" result="grain"/><feColorMatrix in="grain" type="saturate" values="0" result="gg"/><feBlend in="s" in2="gg" mode="multiply" result="gr"/><feComponentTransfer in="gr"><feFuncR type="linear" slope="1.1" intercept="0.05"/><feFuncG type="linear" slope="1.05" intercept="0.03"/><feFuncB type="linear" slope="0.95" intercept="0"/></feComponentTransfer></filter>' +
    '</defs></svg>' +
    '<style>' +
    '*{margin:0;padding:0;box-sizing:border-box}' +
    'body{background:' + T.bg + ';font-family:"Cormorant Garamond",serif;overflow-x:hidden;cursor:crosshair;min-height:100vh;color:' + T.textColor + '}' +
    '#bgCanvas,#ptCanvas{position:fixed;top:0;left:0;width:100vw;height:100vh;pointer-events:none}' +
    '#bgCanvas{z-index:0}#ptCanvas{z-index:3}' +
    '.content{position:relative;z-index:2;max-width:820px;margin:0 auto;padding:40px 20px 60px}' +
    '.opening{text-align:center;padding:60px 20px 40px;opacity:0;animation:fu 2s cubic-bezier(.23,1,.32,1) .5s forwards}' +
    '.wb{width:140px;height:3px;margin:0 auto 30px;background:' + T.borderTop + ';opacity:0;animation:si 1.5s ease-out .8s forwards}' +
    '.sub{font-size:1.1rem;font-weight:300;letter-spacing:5px;text-transform:uppercase;opacity:0;animation:fu 1.5s ease-out 1s forwards}' +
    '.mt{font-family:"Dancing Script",cursive;font-size:clamp(3rem,8vw,5rem);color:' + T.accentColor + ';margin:12px 0;line-height:1.15;opacity:0;animation:fu 1.5s ease-out 1.3s forwards;text-shadow:0 2px 20px ' + T.accentColor + '22}' +
    '.gn{font-family:"Playfair Display",serif;font-size:clamp(1.8rem,4.5vw,2.8rem);font-weight:400;font-style:italic;color:' + T.goldColor + ';opacity:0;animation:fu 1.5s ease-out 1.6s forwards}' +
    '.wb2{width:200px;height:2px;margin:25px auto 0;background:' + T.borderBot + ';opacity:0;animation:si 1.5s ease-out 1.8s forwards}' +
    '.ph{text-align:center;margin:35px 0 10px;font-style:italic;font-size:.95rem;opacity:0;animation:fu 1.5s ease-out 2.2s forwards}' +
    '.bi{display:inline-block;animation:wg 1.5s ease-in-out 4s 3}' +
    '.gallery{display:flex;flex-wrap:wrap;justify-content:center;gap:40px;padding:25px 0 10px;opacity:0;animation:fu 1.8s ease-out 2s forwards}' +
    '.painting{position:relative;cursor:pointer;transition:transform .5s cubic-bezier(.23,1,.32,1);-webkit-tap-highlight-color:transparent}' +
    '.painting:hover{transform:scale(1.03) rotate(0)!important;z-index:4}' +
    '.painting:active{transform:scale(.97)!important}' +
    '.painting:nth-child(1){transform:rotate(-1.5deg)}.painting:nth-child(2){transform:rotate(1.2deg)}' +
    '.frame{position:relative;padding:14px;background:' + T.frame + ';border-radius:3px;box-shadow:0 10px 40px rgba(0,0,0,.2),inset 0 1px 0 rgba(255,255,255,.3)}' +
    '.frame::before{content:"";position:absolute;inset:5px;border:1px solid rgba(255,255,255,.25);border-radius:2px;pointer-events:none}' +
    '.frame-inner{padding:4px;background:' + T.frameInner + ';overflow:hidden}' +
    '.img-wrapper{width:280px;overflow:hidden}' +
    '.painting img{display:block;width:100%;height:auto;transition:filter .7s ease}' +
    '.filter-none img{filter:none}.filter-oil img{filter:url(#oil-painting)}.filter-watercolor img{filter:url(#watercolor)}.filter-sketch img{filter:url(#pencil-sketch)}.filter-popart img{filter:url(#pop-art)}.filter-dreamy img{filter:url(#dreamy)}.filter-vintage img{filter:url(#vintage)}' +
    '.style-badge{position:absolute;top:-12px;right:-12px;color:#fff;font-size:.72rem;font-style:italic;letter-spacing:1.5px;padding:5px 14px;border-radius:14px;z-index:5;opacity:0;transform:scale(.7) translateY(5px);transition:all .4s cubic-bezier(.23,1,.32,1);text-transform:uppercase;white-space:nowrap;box-shadow:0 3px 12px rgba(0,0,0,.25)}' +
    '.style-badge.visible{opacity:1;transform:scale(1) translateY(0)}' +
    '.painting-label{text-align:center;margin-top:14px;font-style:italic;font-size:.9rem;letter-spacing:1px}' +
    '.tp{text-align:center;margin:8px 0 20px;opacity:0;animation:fu 1.5s ease-out 2.5s forwards}' +
    '.tp-inner{display:inline-flex;align-items:center;gap:10px;background:' + T.bg + 'cc;backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);border:1.5px solid ' + T.accentColor + '33;border-radius:24px;padding:10px 22px;font-style:italic;font-size:.95rem;color:' + T.accentColor + ';animation:pp 2.5s ease-in-out 4s 4}' +
    '.th{font-style:normal;font-size:1.2rem;animation:tb 1.6s ease-in-out 4s 5}' +
    '.fd{display:flex;align-items:center;justify-content:center;gap:20px;margin:15px 0 40px;opacity:0;animation:fu 1.5s ease-out 2.8s forwards}' +
    '.fl{width:100px;height:1px;background:linear-gradient(90deg,transparent,' + T.accentColor + '55,transparent)}' +
    '.fi{animation:gs 12s ease-in-out infinite;font-size:1.1rem;opacity:.5}' +
    '.ms{text-align:center;padding:10px 30px 40px;opacity:0;animation:fu 1.8s ease-out 3s forwards}' +
    '.msg{font-size:1.3rem;line-height:2;max-width:550px;margin:0 auto;font-weight:300}' +
    '.hl{color:' + T.accentColor + ';font-style:italic;font-weight:400}' +
    '.sig{margin-top:40px;font-family:"Dancing Script",cursive;font-size:2rem;color:' + T.accentColor + '}' +
    '.hts{margin-top:12px;font-size:1.2rem;opacity:.6;letter-spacing:10px}' +
    '.bf{text-align:center;padding:20px 0 50px;opacity:0;animation:fu 1.5s ease-out 3.3s forwards}' +
    '.ps{position:fixed;pointer-events:none;z-index:10;opacity:0;animation:sin 4s ease-out forwards}' +
    '.pd{position:fixed;pointer-events:none;z-index:10;border-radius:50%;opacity:0;animation:din 2.5s ease-out forwards}' +
    '@keyframes fu{from{opacity:0;transform:translateY(30px)}to{opacity:1;transform:translateY(0)}}' +
    '@keyframes si{from{opacity:0;transform:scaleX(0)}to{opacity:1;transform:scaleX(1)}}' +
    '@keyframes wg{0%,100%{transform:rotate(0)}25%{transform:rotate(-10deg)}75%{transform:rotate(10deg)}}' +
    '@keyframes gs{0%,100%{transform:rotate(0)}50%{transform:rotate(15deg)}}' +
    '@keyframes tb{0%,100%{transform:translateY(0) scale(1)}35%{transform:translateY(-6px) scale(1.2)}}' +
    '@keyframes pp{0%,100%{border-color:' + T.accentColor + '33;box-shadow:none}50%{border-color:' + T.accentColor + '77;box-shadow:0 0 0 8px ' + T.accentColor + '11}}' +
    '@keyframes sin{0%{transform:scale(0) rotate(0);opacity:.9}15%{transform:scale(.5) rotate(15deg);opacity:.75}40%{opacity:.4}100%{transform:scale(1) rotate(40deg);opacity:0}}' +
    '@keyframes din{0%{transform:scale(0) translateY(0);opacity:.75}40%{opacity:.45}100%{transform:scale(1) translateY(18px);opacity:0}}' +
    '@media(max-width:640px){.gallery{gap:25px}.img-wrapper{width:230px}.frame{padding:10px}.content{padding:20px 15px 40px}.msg{font-size:1.1rem;padding:0 10px}.tp-inner{font-size:.82rem;padding:8px 16px}}' +
    '.powered{text-align:center;padding:10px 0 30px;font-family:"Outfit",sans-serif;font-size:.7rem;letter-spacing:2px;text-transform:uppercase;opacity:.3}' +
    '.powered a{color:inherit;text-decoration:none}' +
    '</style></head><body>' +
    '<canvas id="bgCanvas"></canvas><canvas id="ptCanvas"></canvas>' +
    '<div class="content">' +
    '<div class="opening"><div class="wb"></div>' +
    '<p class="sub">' + subtitle + '</p>' +
    '<h1 class="mt">' + title + '</h1>' +
    '<p class="gn">' + recipient + '</p>' +
    '<div class="wb2"></div></div>' +
    '<p class="ph"><span class="bi">&#127912;</span>&nbsp; touch anywhere to paint &nbsp;<span class="bi">&#128396;</span></p>' +
    '<div class="gallery">' + photoHTML + '</div>' +
    '<div class="tp"><div class="tp-inner"><span class="th">&#128072;</span> tap the paintings to transform them into art <span class="th">&#128072;</span></div></div>' +
    '<div class="fd"><div class="fl"></div><span class="fi">&#10047;</span><div class="fl"></div></div>' +
    '<div class="ms"><p class="msg">' + message + '</p>' +
    '<p class="sig">' + sender + '</p>' +
    '<p class="hts">&#10084; &#10084; &#10084;</p></div>' +
    '<div class="bf"><svg width="50" height="50" viewBox="0 0 50 50" fill="none" style="animation:gs 10s ease-in-out infinite"><ellipse cx="25" cy="27" rx="20" ry="17" fill="' + T.bg + '" stroke="' + T.goldColor + '" stroke-width="1.5" opacity=".8"/><circle cx="15" cy="22" r="4" fill="' + T.accentColor + '" opacity=".6"/><circle cx="25" cy="17" r="3.5" fill="' + T.goldColor + '" opacity=".6"/><circle cx="34" cy="22" r="3.8" fill="' + T.accentColor + '88" opacity=".6"/></svg></div>' +
    '<div class="powered">Made with <a href="#">LiveCard Studio</a></div>' +
    '</div>' +
    '<script>' +
    // Background animation
    '(function(){var c=document.getElementById("bgCanvas"),x=c.getContext("2d"),W,H;' +
    'function r(){W=c.width=innerWidth;H=c.height=innerHeight}r();addEventListener("resize",r);' +
    blobsJS +
    'var blobs=[];for(var i=0;i<blobDefs.length;i++){var d=blobDefs[i];blobs.push({x:Math.random()*W,y:Math.random()*H,r:150+Math.random()*250,vx:(Math.random()-.5)*.3,vy:(Math.random()-.5)*.25,c:d,ph:Math.random()*Math.PI*2,bs:.003+Math.random()*.004,ba:.15+Math.random()*.1})}' +
    // Petals
    'var pc=document.getElementById("ptCanvas"),px=pc.getContext("2d");' +
    'function rp(){pc.width=innerWidth;pc.height=innerHeight}rp();addEventListener("resize",rp);' +
    petalsJS +
    'var petals=[];for(var i=0;i<35;i++){petals.push({x:Math.random()*innerWidth,y:Math.random()*innerHeight*2-innerHeight*.5,sz:3+Math.random()*8,sy:.15+Math.random()*.35,sx:(Math.random()-.5)*.3,rot:Math.random()*Math.PI*2,rs:(Math.random()-.5)*.015,wa:15+Math.random()*25,ws:.001+Math.random()*.002,ph:Math.random()*Math.PI*2,col:petalColors[Math.floor(Math.random()*petalColors.length)],op:.15+Math.random()*.25,sh:Math.random()>.5?"p":"c"})}' +
    'function anim(t){' +
    // Draw bg
    'x.fillStyle="' + T.bg + '";x.fillRect(0,0,W,H);' +
    'for(var i=0;i<blobs.length;i++){var b=blobs[i];var br=1+Math.sin(t*b.bs+b.ph)*b.ba;var rr=b.r*br;b.x+=b.vx+Math.sin(t*.001+b.ph)*.15;b.y+=b.vy+Math.cos(t*.0008+b.ph)*.12;if(b.x<-rr)b.x=W+rr;if(b.x>W+rr)b.x=-rr;if(b.y<-rr)b.y=H+rr;if(b.y>H+rr)b.y=-rr;var g=x.createRadialGradient(b.x,b.y,0,b.x,b.y,rr);var a=b.c.a*(.8+.2*Math.sin(t*.002+b.ph));g.addColorStop(0,"rgba("+b.c.r+","+b.c.g+","+b.c.b+","+a+")");g.addColorStop(.5,"rgba("+b.c.r+","+b.c.g+","+b.c.b+","+(a*.4)+")");g.addColorStop(1,"rgba("+b.c.r+","+b.c.g+","+b.c.b+",0)");x.fillStyle=g;x.fillRect(0,0,W,H)}' +
    // Draw petals
    'px.clearRect(0,0,pc.width,pc.height);var sY=pageYOffset||0;' +
    'for(var i=0;i<petals.length;i++){var p=petals[i];p.y+=p.sy;p.x+=p.sx+Math.sin(t*p.ws+p.ph)*.5;p.rot+=p.rs;if(p.y>innerHeight+20){p.y=-20;p.x=Math.random()*innerWidth}var dy=p.y-sY*.15;px.save();px.translate(p.x,dy);px.rotate(p.rot);px.globalAlpha=p.op*(.7+.3*Math.sin(t*.003+p.ph));' +
    'if(p.sh==="p"){px.beginPath();px.moveTo(0,-p.sz);px.bezierCurveTo(p.sz*.8,-p.sz*.5,p.sz*.8,p.sz*.5,0,p.sz);px.bezierCurveTo(-p.sz*.8,p.sz*.5,-p.sz*.8,-p.sz*.5,0,-p.sz);px.fillStyle=p.col+p.op+")";px.fill()}' +
    'else{var gr=px.createRadialGradient(0,0,0,0,0,p.sz);gr.addColorStop(0,p.col+p.op+")");gr.addColorStop(1,p.col+"0)");px.fillStyle=gr;px.fillRect(-p.sz,-p.sz,p.sz*2,p.sz*2)}' +
    'px.restore()}' +
    'requestAnimationFrame(anim)}requestAnimationFrame(anim)})();' +
    // Photo style cycling
    '(function(){var f=["filter-none","filter-oil","filter-watercolor","filter-sketch","filter-popart","filter-dreamy","filter-vintage"];' +
    'var l=["Original","Oil Painting","Watercolor","Pencil Sketch","Pop Art","Dreamy","Vintage"];' +
    'var bc=' + badgeColorsJS + ';' +
    'function cyc(el,bg,cur){var n=(cur+1)%f.length;f.forEach(function(c){el.classList.remove(c)});el.classList.add(f[n]);if(n===0){bg.classList.remove("visible")}else{bg.textContent=l[n];bg.style.background=bc[n];bg.classList.add("visible")}return n}' +
    'var c1=0,c2=0;' +
    'var p1=document.getElementById("painting1");if(p1)p1.addEventListener("click",function(e){e.stopPropagation();c1=cyc(this,document.getElementById("badge1"),c1)});' +
    'var p2=document.getElementById("painting2");if(p2)p2.addEventListener("click",function(e){e.stopPropagation();c2=cyc(this,document.getElementById("badge2"),c2)});' +
    '})();' +
    // Paint splashes
    '(function(){var cs=["rgba(219,84,130,.55)","rgba(130,60,200,.5)","rgba(50,180,120,.45)","rgba(240,140,40,.55)","rgba(50,130,230,.5)","rgba(230,50,70,.5)","rgba(255,200,40,.55)","rgba(100,200,180,.45)","rgba(210,80,180,.5)","rgba(80,170,255,.45)","rgba(255,120,80,.5)","rgba(160,100,220,.45)"];' +
    'function sp(x,y){var e=document.createElement("div");e.className="ps";var s=90+Math.random()*180;var c=cs[Math.floor(Math.random()*cs.length)];e.style.cssText="left:"+(x-s/2)+"px;top:"+(y-s/2)+"px;width:"+s+"px;height:"+s+"px;background:radial-gradient(ellipse at "+(30+Math.random()*40)+"% "+(30+Math.random()*40)+"%,"+c+",transparent 55%);transform:rotate("+(Math.random()*360)+"deg);border-radius:"+(35+Math.random()*25)+"% "+(45+Math.random()*25)+"% "+(35+Math.random()*25)+"% "+(45+Math.random()*25)+"%";document.body.appendChild(e);setTimeout(function(){e.remove()},4000);' +
    'for(var i=0;i<2+Math.floor(Math.random()*3);i++){(function(j){setTimeout(function(){var d=document.createElement("div");d.className="pd";var ds=10+Math.random()*28;var c2=cs[Math.floor(Math.random()*cs.length)];d.style.cssText="left:"+(x+(Math.random()-.5)*s-ds/2)+"px;top:"+(y+(Math.random()-.5)*s-ds/2)+"px;width:"+ds+"px;height:"+ds+"px;background:radial-gradient(circle,"+c2+",transparent 60%)";document.body.appendChild(d);setTimeout(function(){d.remove()},2500)},j*40)})(i)}}' +
    'document.addEventListener("click",function(e){if(e.target.closest(".painting")||e.target.closest(".tp"))return;sp(e.clientX,e.clientY);setTimeout(function(){sp(e.clientX+(Math.random()-.5)*130,e.clientY+(Math.random()-.5)*130)},60)});' +
    'document.addEventListener("touchstart",function(e){if(e.target.closest(".painting")||e.target.closest(".tp"))return;var t=e.touches[0];sp(t.clientX,t.clientY)});' +
    'var dn=false,lt=0;document.addEventListener("mousedown",function(e){if(!e.target.closest(".painting"))dn=true});document.addEventListener("mouseup",function(){dn=false});' +
    'document.addEventListener("mousemove",function(e){if(dn&&Date.now()-lt>45){lt=Date.now();sp(e.clientX,e.clientY)}});' +
    'document.addEventListener("touchmove",function(e){if(e.target.closest(".painting"))return;if(Date.now()-lt>45){lt=Date.now();var t=e.touches[0];sp(t.clientX,t.clientY)}})' +
    '})();' +
    '<\/script></body></html>';
}

// ================================================================
// PREVIEW & DOWNLOAD
// ================================================================
function generatePreview() {
  var html = generateCardHTML();
  var frame = document.getElementById('previewFrame');
  frame.innerHTML = '<iframe sandbox="allow-scripts"></iframe>';
  var iframe = frame.querySelector('iframe');
  iframe.srcdoc = html;
}

document.getElementById('btnDownload').addEventListener('click', function() {
  var html = generateCardHTML();
  var blob = new Blob([html], { type: 'text/html' });
  var url = URL.createObjectURL(blob);
  var a = document.createElement('a');
  a.href = url;
  a.download = 'livecard-for-' + (state.recipientName || 'you').toLowerCase().replace(/[^a-z0-9]/g, '-') + '.html';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  saveCardToDB();
  showToast('Card downloaded! ‚ú®');
});

document.getElementById('btnCopy').addEventListener('click', function() {
  if (navigator.clipboard) {
    navigator.clipboard.writeText('Your LiveCard is ready! Open the downloaded HTML file to view your living greeting card. ‚ú®').then(function() {
      showToast('Share text copied! Download the card to share the file.');
    });
  } else {
    showToast('Download the card and share the HTML file directly.');
  }
});
</script>
</body>
</html>
