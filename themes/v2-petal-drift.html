<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>A Living Card For You</title>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,500;1,300;1,400&family=Nunito+Sans:wght@300;400&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Nunito Sans',sans-serif;overflow:hidden;width:100vw;height:100vh;touch-action:manipulation;-webkit-font-smoothing:antialiased;background:#FDF6EC}
canvas{position:fixed;inset:0;z-index:0}

.envelope-screen{position:fixed;inset:0;z-index:100;display:flex;flex-direction:column;align-items:center;justify-content:center;background:#FDF6EC;cursor:pointer;transition:opacity 1.4s cubic-bezier(.4,0,.2,1),transform 1.4s cubic-bezier(.4,0,.2,1)}
.envelope-screen.opened{opacity:0;transform:scale(1.15);pointer-events:none}
.env-wrap{position:relative;width:160px;height:130px}
.env-body{width:160px;height:100px;background:linear-gradient(145deg,#fff,#FAF0E6);border-radius:5px;position:absolute;bottom:0;box-shadow:0 10px 50px rgba(61,53,53,0.1);border:1px solid rgba(196,145,155,0.12)}
.env-flap{width:0;height:0;border-left:80px solid transparent;border-right:80px solid transparent;border-top:65px solid #EACDD0;position:absolute;top:0;transition:transform 1s cubic-bezier(.4,0,.2,1);transform-origin:top center}
.envelope-screen:hover .env-flap{transform:rotateX(50deg)}
.env-seal{width:30px;height:30px;border-radius:50%;background:linear-gradient(135deg,#C4919B,#A66B78);position:absolute;top:38px;left:50%;transform:translateX(-50%);z-index:2;box-shadow:0 3px 15px rgba(166,107,120,0.35);display:flex;align-items:center;justify-content:center;font-size:0.65rem;color:#FDF6EC;animation:seal 4s ease-in-out infinite}
@keyframes seal{0%,100%{transform:translateX(-50%) scale(1);box-shadow:0 3px 15px rgba(166,107,120,0.35)}50%{transform:translateX(-50%) scale(1.1);box-shadow:0 5px 25px rgba(166,107,120,0.55)}}
.env-hint{margin-top:2.5rem;font-family:'Cormorant Garamond',serif;font-style:italic;font-size:1.05rem;color:#8B7B6B;opacity:0;animation:fi 2s ease 1s forwards}
.env-from{margin-top:.8rem;font-family:'Cormorant Garamond',serif;font-size:.85rem;letter-spacing:.1em;color:#C4919B;opacity:0;animation:fi 2s ease 1.5s forwards}
@keyframes fi{to{opacity:.7}}

.card-exp{position:fixed;inset:0;z-index:10;display:flex;flex-direction:column;align-items:center;justify-content:center;opacity:0;transition:opacity 1.8s ease .6s;pointer-events:none;padding:2rem}
.card-exp.active{opacity:1;pointer-events:auto}

.photo-frame{position:relative;width:min(280px,75vw);height:min(280px,75vw);border-radius:22px;overflow:hidden;cursor:pointer;box-shadow:0 20px 80px rgba(61,53,53,0.12),0 0 0 1px rgba(196,145,155,0.08);transition:transform .6s cubic-bezier(.4,0,.2,1);margin-bottom:2rem;opacity:0;transform:translateY(25px);animation:rev 1.6s ease 1.8s forwards}
@keyframes rev{to{opacity:1;transform:translateY(0)}}
.photo-frame:hover{transform:scale(1.02)}
.photo-frame:active{transform:scale(.98)}
.photo-canvas{width:100%;height:100%;display:block}
.filter-label{position:absolute;bottom:12px;left:50%;transform:translateX(-50%);font-family:'Cormorant Garamond',serif;font-style:italic;font-size:.8rem;color:#fff;background:rgba(61,53,53,.35);backdrop-filter:blur(10px);padding:5px 18px;border-radius:20px;pointer-events:none;transition:opacity .4s}
.tap-hint{position:absolute;top:12px;right:12px;font-size:.6rem;color:#fff;background:rgba(61,53,53,.25);backdrop-filter:blur(8px);padding:3px 10px;border-radius:12px;opacity:0;animation:fi 1.5s ease 3.5s forwards}

.msg{text-align:center;max-width:420px;opacity:0;transform:translateY(25px);animation:rev 1.6s ease 2.6s forwards}
.msg-occ{font-size:.65rem;font-weight:600;letter-spacing:.25em;text-transform:uppercase;color:#C4919B;margin-bottom:.8rem}
.msg-div{display:block;width:45px;height:1px;background:linear-gradient(to right,transparent,#C4919B,transparent);margin:0 auto 1rem}
.msg-txt{font-family:'Cormorant Garamond',serif;font-weight:300;font-size:clamp(1.15rem,3.8vw,1.75rem);line-height:1.65;color:#3D3535;margin-bottom:1.5rem}
.msg-from{font-family:'Cormorant Garamond',serif;font-style:italic;font-size:1.05rem;color:#A66B78}

.branding{position:fixed;bottom:1.5rem;left:50%;transform:translateX(-50%);z-index:20;font-family:'Cormorant Garamond',serif;font-size:.72rem;color:#8B7B6B;opacity:0;letter-spacing:.08em;animation:fi 2s ease 4s forwards}
.branding a{color:#C4919B;text-decoration:none}

@media(max-height:700px){.photo-frame{width:min(200px,55vw);height:min(200px,55vw)}}
</style>
</head>
<body>

<canvas id="c"></canvas>

<div class="envelope-screen" id="env">
  <div class="env-wrap">
    <div class="env-flap"></div>
    <div class="env-body"></div>
    <div class="env-seal">✦</div>
  </div>
  <p class="env-hint">tap to open</p>
  <p class="env-from">from someone who loves you</p>
</div>

<div class="card-exp" id="exp">
  <div class="photo-frame" id="pf">
    <canvas class="photo-canvas" id="pc"></canvas>
    <div class="filter-label" id="fl">Original</div>
    <div class="tap-hint">tap to transform</div>
  </div>
  <div class="msg">
    <p class="msg-occ">Happy Birthday</p>
    <span class="msg-div"></span>
    <p class="msg-txt">You make the world more beautiful just by being in it. Here's to another year of your magic.</p>
    <p class="msg-from">— with all my love, always</p>
  </div>
</div>

<div class="branding">made with <a href="#">LiveCardStudio</a> — cards that breathe</div>

<script>
// ═══════════════════════════════════════════════════════
// PERLIN NOISE (simplex-like)
// ═══════════════════════════════════════════════════════
const P = new Uint8Array(512);
const G = [];
(function(){
  const p = [];
  for(let i=0;i<256;i++) p[i]=i;
  for(let i=255;i>0;i--){const j=Math.floor(Math.random()*(i+1));[p[i],p[j]]=[p[j],p[i]];}
  for(let i=0;i<512;i++) P[i]=p[i&255];
  for(let i=0;i<256;i++){const a=Math.random()*Math.PI*2;G[i]=[Math.cos(a),Math.sin(a)];}
})();

function fade(t){return t*t*t*(t*(t*6-15)+10)}
function lerp(a,b,t){return a+(b-a)*t}
function dot2(g,x,y){return g[0]*x+g[1]*y}

function noise2D(x,y){
  const X=Math.floor(x)&255, Y=Math.floor(y)&255;
  const xf=x-Math.floor(x), yf=y-Math.floor(y);
  const u=fade(xf), v=fade(yf);
  const aa=P[P[X]+Y], ab=P[P[X]+Y+1], ba=P[P[X+1]+Y], bb=P[P[X+1]+Y+1];
  return lerp(lerp(dot2(G[aa],xf,yf),dot2(G[ba],xf-1,yf),u),lerp(dot2(G[ab],xf,yf-1),dot2(G[bb],xf-1,yf-1),u),v);
}

function fbm(x,y,octaves=4){
  let val=0,amp=0.5,freq=1;
  for(let i=0;i<octaves;i++){val+=amp*noise2D(x*freq,y*freq);amp*=0.5;freq*=2;}
  return val;
}

// ═══════════════════════════════════════════════════════
// CORE
// ═══════════════════════════════════════════════════════
const canvas=document.getElementById('c');
const ctx=canvas.getContext('2d');
let W,H,t=0,mx=0,my=0,mxSmooth=0,mySmooth=0,cardOpen=false;
let lastMx=0,lastMy=0,windX=0,windY=0;

function resize(){W=canvas.width=innerWidth;H=canvas.height=innerHeight;}
resize();
addEventListener('resize',resize);
addEventListener('mousemove',e=>{mx=e.clientX;my=e.clientY});
addEventListener('touchmove',e=>{mx=e.touches[0].clientX;my=e.touches[0].clientY},{passive:true});

// ═══════════════════════════════════════════════════════
// LAYER 1: Watercolor wash background
// ═══════════════════════════════════════════════════════
class WatercolorWash {
  constructor(){
    this.x=Math.random()*W;
    this.y=Math.random()*H;
    this.baseR=130+Math.random()*320;
    this.hue=[338,345,352,22,30,15,355][Math.floor(Math.random()*7)];
    this.sat=18+Math.random()*28;
    this.light=86+Math.random()*9;
    this.alpha=0.06+Math.random()*0.12;
    this.phase=Math.random()*Math.PI*2;
    this.bSpeed=0.0002+Math.random()*0.0004;
    this.noiseOff=Math.random()*100;
  }
  draw(t){
    const n=fbm(this.noiseOff+t*0.00005,this.noiseOff+t*0.00003);
    const breathe=(Math.sin(t*this.bSpeed+this.phase)+n*0.5)*0.18+1;
    const r=this.baseR*breathe;
    const nx=noise2D(this.noiseOff+t*0.00008,0)*50;
    const ny=noise2D(0,this.noiseOff+t*0.00006)*40;
    const x=this.x+nx;
    const y=this.y+ny;
    
    // Mouse push
    const dx=mxSmooth-x,dy=mySmooth-y;
    const dist=Math.sqrt(dx*dx+dy*dy);
    const push=Math.max(0,1-dist/350)*12;
    const px=x-dx/(dist||1)*push;
    const py=y-dy/(dist||1)*push;
    
    const hShift=noise2D(t*0.0001,this.noiseOff)*8;
    const grad=ctx.createRadialGradient(px,py,0,px,py,r);
    grad.addColorStop(0,`hsla(${this.hue+hShift},${this.sat}%,${this.light}%,${this.alpha})`);
    grad.addColorStop(0.35,`hsla(${this.hue+hShift+3},${this.sat-2}%,${this.light+1}%,${this.alpha*0.65})`);
    grad.addColorStop(0.7,`hsla(${this.hue+hShift-2},${this.sat-4}%,${this.light+2}%,${this.alpha*0.25})`);
    grad.addColorStop(1,`hsla(${this.hue},${this.sat}%,${this.light}%,0)`);
    ctx.fillStyle=grad;
    ctx.beginPath();ctx.arc(px,py,r,0,Math.PI*2);ctx.fill();
  }
}

// ═══════════════════════════════════════════════════════
// LAYER 2: Depth petals (3 depth layers with parallax)
// ═══════════════════════════════════════════════════════
class Petal {
  constructor(depth){
    this.depth=depth; // 0=far, 1=mid, 2=near
    this.depthScale=[0.4,0.7,1.0][depth];
    this.depthAlpha=[0.12,0.22,0.35][depth];
    this.depthBlur=[0.5,0.2,0][depth];
    this.reset(true);
  }
  reset(init){
    this.x=Math.random()*W;
    this.y=init?Math.random()*H:-20-Math.random()*120;
    this.baseSize=(3+Math.random()*5)*this.depthScale;
    this.speedY=(0.08+Math.random()*0.2)*this.depthScale+0.05;
    this.speedX=(Math.random()-0.5)*0.12;
    this.rot=Math.random()*Math.PI*2;
    this.rotSpeed=(Math.random()-0.5)*0.015;
    this.tilt=Math.random()*Math.PI*2; // 3D tilt phase
    this.tiltSpeed=0.008+Math.random()*0.015;
    this.alpha=this.depthAlpha+Math.random()*0.1;
    this.type=Math.floor(Math.random()*4);
    this.hue=[340,348,355,18][this.type];
    this.sat=[32,28,35,25][this.type];
    this.light=[84,88,82,90][this.type];
    this.wobblePhase=Math.random()*Math.PI*2;
    this.wobbleAmp=(0.15+Math.random()*0.4)*this.depthScale;
    this.noiseOff=Math.random()*200;
    this.golden=false;
    // Rare golden petal
    if(Math.random()<0.02){this.golden=true;this.hue=38;this.sat=55;this.light=75;this.alpha*=1.3;}
  }
  update(t){
    const noiseX=noise2D(this.noiseOff+t*0.0003,this.y*0.003)*this.wobbleAmp*2;
    const noiseY=noise2D(this.y*0.003,this.noiseOff+t*0.0002)*0.3;
    
    this.y+=this.speedY+noiseY;
    this.x+=this.speedX+noiseX+windX*this.depthScale*0.3;
    this.rot+=this.rotSpeed+noise2D(t*0.0005,this.noiseOff)*0.005;
    this.tilt+=this.tiltSpeed;
    
    if(this.y>H+30) this.reset(false);
    if(this.x<-30) this.x=W+30;
    if(this.x>W+30) this.x=-30;
  }
  draw(t){
    const tiltScale=Math.abs(Math.cos(this.tilt)); // simulates 3D flip
    const sz=this.baseSize*(0.9+Math.sin(t*0.002+this.wobblePhase)*0.1);
    
    ctx.save();
    ctx.translate(this.x,this.y);
    ctx.rotate(this.rot);
    ctx.scale(1,tiltScale*0.6+0.4);
    ctx.globalAlpha=this.alpha*(0.7+tiltScale*0.3);
    
    // Petal body
    const h=this.hue+noise2D(t*0.0002,this.noiseOff)*6;
    ctx.fillStyle=`hsl(${h},${this.sat}%,${this.light}%)`;
    ctx.beginPath();
    ctx.moveTo(0,-sz*0.6);
    ctx.bezierCurveTo(sz*0.55,-sz*0.55,sz*0.65,sz*0.15,0,sz*0.6);
    ctx.bezierCurveTo(-sz*0.65,sz*0.15,-sz*0.55,-sz*0.55,0,-sz*0.6);
    ctx.fill();
    
    // Inner vein
    ctx.strokeStyle=`hsla(${h-5},${this.sat-5}%,${this.light-8}%,0.15)`;
    ctx.lineWidth=0.3;
    ctx.beginPath();
    ctx.moveTo(0,-sz*0.4);
    ctx.quadraticCurveTo(sz*0.05,0,0,sz*0.4);
    ctx.stroke();
    
    // Highlight
    ctx.globalAlpha=this.alpha*0.25*tiltScale;
    ctx.fillStyle='#fff';
    ctx.beginPath();
    ctx.ellipse(-sz*0.12,-sz*0.18,sz*0.28,sz*0.18,-0.3,0,Math.PI*2);
    ctx.fill();
    
    // Golden shimmer
    if(this.golden){
      ctx.globalAlpha=0.15+Math.sin(t*0.01+this.noiseOff)*0.1;
      const g=ctx.createRadialGradient(0,0,0,0,0,sz*1.5);
      g.addColorStop(0,'rgba(232,200,122,0.4)');
      g.addColorStop(1,'rgba(232,200,122,0)');
      ctx.fillStyle=g;
      ctx.beginPath();ctx.arc(0,0,sz*1.5,0,Math.PI*2);ctx.fill();
    }
    
    ctx.restore();
  }
}

// ═══════════════════════════════════════════════════════
// LAYER 3: Light particles / bokeh
// ═══════════════════════════════════════════════════════
class Bokeh {
  constructor(){
    this.x=Math.random()*W;
    this.y=Math.random()*H;
    this.size=2+Math.random()*8;
    this.alpha=0.03+Math.random()*0.06;
    this.phase=Math.random()*Math.PI*2;
    this.driftSpeed=0.05+Math.random()*0.1;
    this.driftAngle=Math.random()*Math.PI*2;
    this.noiseOff=Math.random()*100;
    this.hue=[340,25,350,10][Math.floor(Math.random()*4)];
  }
  update(t){
    const n=noise2D(this.noiseOff+t*0.0001,t*0.00005);
    this.x+=Math.cos(this.driftAngle+n)*this.driftSpeed;
    this.y+=Math.sin(this.driftAngle+n)*this.driftSpeed-0.02;
    if(this.y<-20){this.y=H+20;this.x=Math.random()*W;}
    if(this.x<-20)this.x=W+20;
    if(this.x>W+20)this.x=-20;
  }
  draw(t){
    const pulse=0.6+Math.sin(t*0.003+this.phase)*0.4;
    const a=this.alpha*pulse;
    
    // Outer ring
    ctx.globalAlpha=a*0.5;
    ctx.strokeStyle=`hsla(${this.hue},25%,85%,1)`;
    ctx.lineWidth=0.5;
    ctx.beginPath();ctx.arc(this.x,this.y,this.size,0,Math.PI*2);ctx.stroke();
    
    // Inner glow
    const g=ctx.createRadialGradient(this.x,this.y,0,this.x,this.y,this.size);
    g.addColorStop(0,`hsla(${this.hue},30%,90%,${a})`);
    g.addColorStop(0.5,`hsla(${this.hue},25%,88%,${a*0.3})`);
    g.addColorStop(1,`hsla(${this.hue},20%,85%,0)`);
    ctx.globalAlpha=1;
    ctx.fillStyle=g;
    ctx.beginPath();ctx.arc(this.x,this.y,this.size,0,Math.PI*2);ctx.fill();
  }
}

// ═══════════════════════════════════════════════════════
// LAYER 4: Subtle light diffraction streaks
// ═══════════════════════════════════════════════════════
function drawLightStreaks(t){
  const breathe=Math.sin(t*0.0004)*0.5+0.5;
  ctx.save();
  ctx.globalAlpha=0.02*breathe;
  ctx.globalCompositeOperation='screen';
  
  for(let i=0;i<3;i++){
    const x=W*(0.3+i*0.2)+Math.sin(t*0.0002+i*2)*40;
    const y=H*0.2+Math.cos(t*0.00015+i)*30;
    const angle=0.4+i*0.3+Math.sin(t*0.0003)*0.1;
    const len=200+Math.sin(t*0.0005+i)*50;
    
    const g=ctx.createLinearGradient(
      x-Math.cos(angle)*len,y-Math.sin(angle)*len,
      x+Math.cos(angle)*len,y+Math.sin(angle)*len
    );
    g.addColorStop(0,'rgba(232,196,200,0)');
    g.addColorStop(0.3,'rgba(232,196,200,0.5)');
    g.addColorStop(0.5,'rgba(255,240,230,0.7)');
    g.addColorStop(0.7,'rgba(232,196,200,0.5)');
    g.addColorStop(1,'rgba(232,196,200,0)');
    
    ctx.fillStyle=g;
    ctx.save();
    ctx.translate(x,y);
    ctx.rotate(angle);
    ctx.fillRect(-len,-2-i,len*2,4+i*2);
    ctx.restore();
  }
  
  ctx.restore();
}

// ═══════════════════════════════════════════════════════
// LAYER 5: Watercolor edge bleeding
// ═══════════════════════════════════════════════════════
function drawEdgeBleeds(t){
  const edges=[
    {x:0,y:H*0.3,w:80,h:H*0.4,hue:345},
    {x:W-60,y:H*0.2,w:60,h:H*0.5,hue:25},
    {x:W*0.2,y:H-50,w:W*0.6,h:50,hue:350},
    {x:W*0.3,y:0,w:W*0.4,h:40,hue:340},
  ];
  
  edges.forEach((e,i)=>{
    const breathe=Math.sin(t*0.0003+i*1.5)*0.3+0.7;
    const n=noise2D(t*0.00005+i,i*10)*15;
    const g=ctx.createRadialGradient(e.x+e.w/2+n,e.y+e.h/2,0,e.x+e.w/2+n,e.y+e.h/2,Math.max(e.w,e.h)*0.8);
    g.addColorStop(0,`hsla(${e.hue},25%,88%,${0.06*breathe})`);
    g.addColorStop(1,`hsla(${e.hue},25%,88%,0)`);
    ctx.fillStyle=g;
    ctx.fillRect(e.x-30+n,e.y-30,e.w+60,e.h+60);
  });
}

// ═══════════════════════════════════════════════════════
// LAYER 6: Micro dust particles
// ═══════════════════════════════════════════════════════
class DustMote {
  constructor(){
    this.x=Math.random()*W;
    this.y=Math.random()*H;
    this.size=0.5+Math.random()*1;
    this.alpha=0.08+Math.random()*0.12;
    this.speed=0.02+Math.random()*0.05;
    this.angle=Math.random()*Math.PI*2;
    this.noiseOff=Math.random()*200;
    this.twinkle=0.003+Math.random()*0.006;
    this.phase=Math.random()*Math.PI*2;
  }
  update(t){
    const n=noise2D(this.noiseOff+t*0.0002,this.y*0.01);
    this.x+=Math.cos(this.angle+n*2)*this.speed+windX*0.05;
    this.y+=Math.sin(this.angle+n)*this.speed-0.01;
    if(this.x<0)this.x=W;if(this.x>W)this.x=0;
    if(this.y<0)this.y=H;if(this.y>H)this.y=0;
  }
  draw(t){
    const tw=0.3+Math.sin(t*this.twinkle+this.phase)*0.7;
    ctx.globalAlpha=this.alpha*tw;
    ctx.fillStyle='rgba(212,165,116,0.8)';
    ctx.beginPath();ctx.arc(this.x,this.y,this.size,0,Math.PI*2);ctx.fill();
    ctx.globalAlpha=1;
  }
}

// ═══════════════════════════════════════════════════════
// INIT ALL LAYERS
// ═══════════════════════════════════════════════════════
const washes=Array.from({length:10},()=>new WatercolorWash());
const petalsFar=Array.from({length:12},()=>new Petal(0));
const petalsMid=Array.from({length:15},()=>new Petal(1));
const petalsNear=Array.from({length:10},()=>new Petal(2));
const bokehs=Array.from({length:12},()=>new Bokeh());
const dust=Array.from({length:60},()=>new DustMote());

// Touch-spawned petals
const touchPetals=[];

// ═══════════════════════════════════════════════════════
// RENDER
// ═══════════════════════════════════════════════════════
function render(){
  t++;
  
  // Smooth mouse
  mxSmooth+=(mx-mxSmooth)*0.03;
  mySmooth+=(my-mySmooth)*0.03;
  
  // Wind from mouse movement
  windX+=(mx-lastMx)*0.01-windX*0.02;
  windY+=(my-lastMy)*0.01-windY*0.02;
  lastMx+=(mx-lastMx)*0.1;
  lastMy+=(my-lastMy)*0.1;
  
  // Background
  ctx.fillStyle='rgba(253,246,236,0.94)';
  ctx.fillRect(0,0,W,H);
  
  // Subtle noise texture overlay
  if(t%3===0){
    for(let i=0;i<100;i++){
      ctx.fillStyle=`rgba(139,123,107,${Math.random()*0.008})`;
      ctx.fillRect(Math.random()*W,Math.random()*H,1,1);
    }
  }
  
  // Layer 1: Watercolor washes
  washes.forEach(w=>w.draw(t));
  
  // Layer 2: Edge bleeds
  drawEdgeBleeds(t);
  
  // Layer 3: Far petals (background depth)
  petalsFar.forEach(p=>{p.update(t);p.draw(t);});
  
  // Layer 4: Bokeh
  bokehs.forEach(b=>{b.update(t);b.draw(t);});
  
  // Layer 5: Mid petals
  petalsMid.forEach(p=>{p.update(t);p.draw(t);});
  
  // Layer 6: Light streaks
  drawLightStreaks(t);
  
  // Layer 7: Dust motes
  dust.forEach(d=>{d.update(t);d.draw(t);});
  
  // Layer 8: Near petals (foreground)
  petalsNear.forEach(p=>{p.update(t);p.draw(t);});
  
  // Touch petals
  touchPetals.forEach(p=>{p.update(t);p.draw(t);});
  
  // Cleanup dead touch petals
  for(let i=touchPetals.length-1;i>=0;i--){
    if(touchPetals[i].y>H+30||touchPetals[i].y<-30) touchPetals.splice(i,1);
  }
  
  requestAnimationFrame(render);
}
render();

// ═══════════════════════════════════════════════════════
// ENVELOPE
// ═══════════════════════════════════════════════════════
const env=document.getElementById('env');
const exp=document.getElementById('exp');
env.addEventListener('click',()=>{
  env.classList.add('opened');
  cardOpen=true;
  setTimeout(()=>{exp.classList.add('active');env.style.display='none';},700);
});

// ═══════════════════════════════════════════════════════
// PHOTO + FILTERS
// ═══════════════════════════════════════════════════════
const pc=document.getElementById('pc');
const pctx=pc.getContext('2d');
const fl=document.getElementById('fl');
const FILTERS=['Original','Watercolor','Oil Paint','Soft Sketch','Dreamy'];
let cf=0,origData;

function genPhoto(w,h){
  const o=document.createElement('canvas');o.width=w;o.height=h;
  const c=o.getContext('2d');
  const bg=c.createLinearGradient(0,0,w,h);
  bg.addColorStop(0,'#E8D4BC');bg.addColorStop(0.3,'#D4A574');bg.addColorStop(0.6,'#C4919B');bg.addColorStop(1,'#A66B78');
  c.fillStyle=bg;c.fillRect(0,0,w,h);
  for(let i=0;i<12;i++){
    const x=w*0.15+Math.random()*w*0.7,y=h*0.15+Math.random()*h*0.7,r=25+Math.random()*80;
    const g=c.createRadialGradient(x,y,0,x,y,r);
    const hue=330+Math.random()*50;
    g.addColorStop(0,`hsla(${hue},35%,75%,0.5)`);g.addColorStop(1,`hsla(${hue},35%,75%,0)`);
    c.fillStyle=g;c.beginPath();c.arc(x,y,r,0,Math.PI*2);c.fill();
  }
  for(let i=0;i<4000;i++){c.fillStyle=`rgba(255,255,255,${Math.random()*0.04})`;c.fillRect(Math.random()*w,Math.random()*h,1,1);}
  c.font='300 15px "Cormorant Garamond",serif';c.textAlign='center';c.fillStyle='rgba(61,53,53,0.3)';
  c.fillText('your photo here',w/2,h*0.83);
  c.font='300 10px "Nunito Sans",sans-serif';c.fillText('(tap to see art filters)',w/2,h*0.89);
  return o;
}

function initPhoto(){
  const f=document.getElementById('pf');const s=f.offsetWidth||280;
  pc.width=s;pc.height=s;
  pctx.drawImage(genPhoto(s,s),0,0);
  origData=pctx.getImageData(0,0,s,s);
}

function applyFilter(n){
  const w=pc.width,h=pc.height;
  pctx.putImageData(origData,0,0);
  if(n==='Original')return;
  const id=pctx.getImageData(0,0,w,h),d=id.data;
  
  if(n==='Watercolor'){
    pctx.putImageData(id,0,0);
    pctx.globalAlpha=0.25;
    for(let i=0;i<6;i++){pctx.drawImage(pc,(Math.random()-0.5)*5,(Math.random()-0.5)*5);}
    pctx.globalAlpha=1;
    for(let i=0;i<6000;i++){
      const a=Math.random()*0.05;
      pctx.fillStyle=Math.random()>0.5?`rgba(255,255,255,${a})`:`rgba(139,123,107,${a*0.4})`;
      pctx.fillRect(Math.random()*w,Math.random()*h,1+Math.random()*2,1+Math.random()*2);
    }
    const eg=pctx.createRadialGradient(w/2,h/2,w*0.25,w/2,h/2,w*0.55);
    eg.addColorStop(0,'rgba(253,246,236,0)');eg.addColorStop(1,'rgba(253,246,236,0.35)');
    pctx.fillStyle=eg;pctx.fillRect(0,0,w,h);
    // Watercolor edge bleeds
    for(let i=0;i<8;i++){
      const bx=Math.random()*w,by=Math.random()*h,br=20+Math.random()*40;
      const bg=pctx.createRadialGradient(bx,by,0,bx,by,br);
      const bh=330+Math.random()*40;
      bg.addColorStop(0,`hsla(${bh},30%,80%,0.08)`);bg.addColorStop(1,`hsla(${bh},30%,80%,0)`);
      pctx.fillStyle=bg;pctx.beginPath();pctx.arc(bx,by,br,0,Math.PI*2);pctx.fill();
    }
  } else if(n==='Oil Paint'){
    for(let i=0;i<d.length;i+=4){
      d[i]=Math.min(255,d[i]*1.1);d[i+1]*=0.95;d[i+2]*=0.88;
      for(let c2=0;c2<3;c2++) d[i+c2]=Math.min(255,Math.max(0,(d[i+c2]-128)*1.25+128));
    }
    pctx.putImageData(id,0,0);
    pctx.globalAlpha=0.12;
    for(let i=0;i<10;i++){pctx.drawImage(pc,(Math.random()-0.5)*3,(Math.random()-0.5)*3);}
    pctx.globalAlpha=1;
    for(let y2=0;y2<h;y2+=2){pctx.fillStyle=`rgba(139,123,107,${0.008+Math.random()*0.015})`;pctx.fillRect(0,y2,w,1);}
    for(let x2=0;x2<w;x2+=3){pctx.fillStyle=`rgba(139,123,107,${0.005+Math.random()*0.01})`;pctx.fillRect(x2,0,1,h);}
  } else if(n==='Soft Sketch'){
    for(let i=0;i<d.length;i+=4){
      const gray=d[i]*0.3+d[i+1]*0.59+d[i+2]*0.11;
      d[i]=Math.min(255,gray*1.05+22);d[i+1]=gray+17;d[i+2]=gray+12;
    }
    pctx.putImageData(id,0,0);
    pctx.fillStyle='rgba(253,246,236,0.28)';pctx.fillRect(0,0,w,h);
    for(let i=0;i<3000;i++){
      const x=Math.random()*w,y=Math.random()*h,len=2+Math.random()*10;
      const a=Math.random()*Math.PI;
      pctx.strokeStyle=`rgba(61,53,53,${0.015+Math.random()*0.04})`;
      pctx.lineWidth=0.3+Math.random()*0.4;pctx.beginPath();
      pctx.moveTo(x,y);pctx.lineTo(x+Math.cos(a)*len,y+Math.sin(a)*len);pctx.stroke();
    }
  } else if(n==='Dreamy'){
    for(let i=0;i<d.length;i+=4){
      d[i]=Math.min(255,d[i]*1.12+18);d[i+1]=Math.min(255,d[i+1]*1.06+12);d[i+2]=Math.min(255,d[i+2]+22);
    }
    pctx.putImageData(id,0,0);
    pctx.globalAlpha=0.22;
    for(let i=0;i<7;i++){pctx.drawImage(pc,(Math.random()-0.5)*7,(Math.random()-0.5)*7);}
    pctx.globalAlpha=1;
    const v=pctx.createRadialGradient(w/2,h/2,w*0.15,w/2,h/2,w*0.6);
    v.addColorStop(0,'rgba(253,246,236,0)');v.addColorStop(0.6,'rgba(232,196,200,0.12)');v.addColorStop(1,'rgba(212,165,116,0.22)');
    pctx.fillStyle=v;pctx.fillRect(0,0,w,h);
    for(let i=0;i<25;i++){
      const x=Math.random()*w,y=Math.random()*h,r=0.5+Math.random()*2;
      pctx.fillStyle=`rgba(255,255,255,${0.2+Math.random()*0.35})`;
      pctx.beginPath();pctx.arc(x,y,r,0,Math.PI*2);pctx.fill();
    }
  }
}

document.getElementById('pf').addEventListener('click',e=>{
  cf=(cf+1)%FILTERS.length;
  pc.style.transition='opacity .3s';pc.style.opacity='.4';
  setTimeout(()=>{applyFilter(FILTERS[cf]);fl.textContent=FILTERS[cf];pc.style.opacity='1';},250);
  spawnBurst(e.clientX,e.clientY);
});

// ═══════════════════════════════════════════════════════
// TOUCH INTERACTIONS
// ═══════════════════════════════════════════════════════
function spawnBurst(x,y){
  for(let i=0;i<6;i++){
    const p=new Petal(2);
    p.x=x+(Math.random()-0.5)*60;
    p.y=y+(Math.random()-0.5)*60;
    p.speedY=-(0.3+Math.random()*0.6);
    p.speedX=(Math.random()-0.5)*0.8;
    p.alpha=0.3+Math.random()*0.3;
    touchPetals.push(p);
  }
}

document.addEventListener('click',e=>{
  if(e.target.closest('.envelope-screen')||e.target.closest('.photo-frame'))return;
  spawnBurst(e.clientX,e.clientY);
});

document.fonts.ready.then(()=>setTimeout(initPhoto,100));
addEventListener('resize',()=>{resize();setTimeout(initPhoto,100);});
</script>
</body>
</html>
