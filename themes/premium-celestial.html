<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>‚ú¶ LiveCardStudio ‚Äî Celestial</title>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,600;1,300;1,400&family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }
html { scroll-behavior: smooth; }
body {
  font-family:'Cormorant Garamond', serif;
  background:#05051a; color:#e8e0f0;
  overflow-x:hidden; -webkit-font-smoothing:antialiased;
}

/* ===== ENVELOPE ===== */
.envelope-screen {
  position:fixed; top:0; left:0; width:100%; height:100vh;
  z-index:1000; display:flex; align-items:center; justify-content:center;
  background:radial-gradient(ellipse at 50% 30%, #12103a 0%, #08071e 50%, #020118 100%);
  transition:opacity 1.2s cubic-bezier(.4,0,.2,1), transform 1.2s cubic-bezier(.4,0,.2,1);
}
.envelope-screen.opened {
  opacity:0; pointer-events:none; transform:scale(1.05);
}
.envelope-wrap {
  position:relative; width:320px; height:220px; cursor:pointer;
  transform:translateY(20px); opacity:0;
  animation:envFloat 1.2s 0.3s cubic-bezier(.16,1,.3,1) forwards;
}
@keyframes envFloat { to { transform:translateY(0); opacity:1; } }
.envelope-body {
  width:100%; height:100%; border-radius:8px; position:relative;
  background:linear-gradient(135deg, #1a1650 0%, #0d0b30 100%);
  box-shadow:0 20px 60px rgba(0,0,0,0.6), inset 0 1px 0 rgba(180,160,255,0.1);
  overflow:hidden;
}
.envelope-body::before {
  content:''; position:absolute; top:0; left:0; right:0; bottom:0;
  background:radial-gradient(circle at 50% 0%, rgba(120,100,220,0.15) 0%, transparent 60%);
}
.envelope-flap {
  position:absolute; top:0; left:0; width:100%; height:55%;
  background:linear-gradient(180deg, #1e1860 0%, #151050 100%);
  clip-path:polygon(0 0, 50% 65%, 100% 0);
  transform-origin:top center; transition:transform 0.8s cubic-bezier(.4,0,.2,1);
  z-index:2; box-shadow:0 4px 20px rgba(0,0,0,0.3);
}
.envelope-wrap.opening .envelope-flap { transform:rotateX(180deg); }
.envelope-seal {
  position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);
  width:64px; height:64px; border-radius:50%; z-index:3;
  background:radial-gradient(circle, #c9a0ff 0%, #7b5ea7 60%, #4a3580 100%);
  box-shadow:0 0 30px rgba(180,140,255,0.5), 0 0 60px rgba(180,140,255,0.2);
  display:flex; align-items:center; justify-content:center;
  font-size:26px; transition:all 0.6s ease;
  animation:sealPulse 2.5s ease-in-out infinite;
}
@keyframes sealPulse {
  0%,100% { box-shadow:0 0 30px rgba(180,140,255,0.5), 0 0 60px rgba(180,140,255,0.2); }
  50% { box-shadow:0 0 40px rgba(180,140,255,0.7), 0 0 80px rgba(180,140,255,0.3); }
}
.envelope-tagline {
  position:absolute; bottom:20px; left:0; right:0; text-align:center;
  font-family:'Cormorant Garamond', serif; font-style:italic;
  font-size:0.8rem; color:rgba(180,160,240,0.5); letter-spacing:0.15em;
}
.env-stars {
  position:absolute; top:0; left:0; width:100%; height:100%; pointer-events:none;
}

/* ===== UNIVERSE CANVAS ===== */
.universe-canvas {
  position:fixed; top:0; left:0; width:100%; height:100%;
  z-index:0; pointer-events:none;
}

/* ===== SOUND REACTIVE OVERLAY ===== */
.sound-reactive-layer {
  position:fixed; top:0; left:0; width:100%; height:100%;
  z-index:1; pointer-events:none; opacity:0.6;
}

/* ===== CONTENT ===== */
.card-content {
  position:relative; z-index:5; opacity:0;
  transition:opacity 1.5s ease 0.5s;
  min-height:100vh;
}
.card-content.visible { opacity:1; }

/* ===== HERO ===== */
.hero-section {
  height:100vh; display:flex; flex-direction:column;
  align-items:center; justify-content:center;
  text-align:center; padding:40px 20px;
  position:relative; overflow:hidden;
}
.hero-occasion {
  font-size:0.75rem; letter-spacing:0.35em; text-transform:uppercase;
  color:rgba(180,160,240,0.7); margin-bottom:16px;
  opacity:0; transform:translateY(20px);
  animation:fadeUp 1s 1.5s ease forwards;
}
.hero-name {
  font-family:'Playfair Display', serif; font-size:clamp(2.5rem,8vw,5rem);
  font-weight:700; line-height:1.1;
  background:linear-gradient(135deg, #e8d5ff 0%, #c9a0ff 40%, #f0d0a0 70%, #ffd700 100%);
  -webkit-background-clip:text; -webkit-text-fill-color:transparent;
  background-clip:text; margin-bottom:24px;
  opacity:0; transform:translateY(30px);
  animation:fadeUp 1.2s 1.8s ease forwards;
}
.hero-subtitle {
  font-style:italic; font-size:1.3rem; color:rgba(200,180,240,0.6);
  opacity:0; transform:translateY(20px);
  animation:fadeUp 1s 2.2s ease forwards;
}
.hero-divider {
  width:80px; height:1px; margin:30px auto;
  background:linear-gradient(to right, transparent, rgba(180,140,255,0.4), rgba(255,215,0,0.3), transparent);
  opacity:0; animation:fadeUp 1s 2.5s ease forwards;
}
.scroll-hint {
  position:absolute; bottom:40px; left:50%; transform:translateX(-50%);
  opacity:0; animation:fadeUp 1s 3s ease forwards;
  display:flex; flex-direction:column; align-items:center; gap:8px;
}
.scroll-hint span {
  font-size:0.7rem; letter-spacing:0.2em; text-transform:uppercase;
  color:rgba(180,160,240,0.4);
}
.scroll-arrow {
  width:20px; height:20px; border-right:1px solid rgba(180,160,240,0.3);
  border-bottom:1px solid rgba(180,160,240,0.3);
  transform:rotate(45deg); animation:scrollBounce 2s ease-in-out infinite;
}
@keyframes scrollBounce {
  0%,100% { transform:rotate(45deg) translate(0,0); opacity:0.3; }
  50% { transform:rotate(45deg) translate(5px,5px); opacity:0.7; }
}
@keyframes fadeUp {
  to { opacity:1; transform:translateY(0); }
}

/* ===== PHOTO SECTIONS ===== */
.photo-section {
  padding:80px 20px; max-width:900px; margin:0 auto;
  opacity:0; transform:translateY(60px);
  transition:all 1.2s cubic-bezier(.16,1,.3,1);
}
.photo-section.in-view { opacity:1; transform:translateY(0); }

.photo-frame {
  position:relative; border-radius:12px; overflow:hidden;
  box-shadow:0 30px 80px rgba(0,0,0,0.5), 0 0 40px rgba(120,80,200,0.1);
  transform:perspective(800px) rotateX(0deg) rotateY(0deg);
  transition:transform 0.15s ease-out;
}
.photo-frame img {
  width:100%; display:block; filter:brightness(0.95) saturate(1.1);
}
.photo-overlay {
  position:absolute; top:0; left:0; right:0; bottom:0;
  background:linear-gradient(180deg, transparent 60%, rgba(5,5,26,0.8) 100%);
  pointer-events:none;
}
.photo-glow {
  position:absolute; top:-20%; left:-20%; width:140%; height:140%;
  background:radial-gradient(circle, rgba(180,140,255,0.08) 0%, transparent 60%);
  pointer-events:none; animation:glowDrift 8s ease-in-out infinite alternate;
}
@keyframes glowDrift {
  0% { transform:translate(-10%,-10%); }
  100% { transform:translate(10%,10%); }
}

/* Duo layout */
.photo-duo {
  display:grid; grid-template-columns:1fr 1fr; gap:20px;
}
.photo-duo .photo-frame { aspect-ratio:3/4; }

/* ===== CONSTELLATION DIVIDERS ===== */
.constellation-divider {
  height:200px; display:flex; align-items:center; justify-content:center;
  position:relative; overflow:hidden;
}
.constellation-divider canvas {
  position:absolute; top:0; left:0; width:100%; height:100%;
}

/* ===== TEXT SECTIONS ===== */
.text-section {
  text-align:center; padding:60px 20px; max-width:700px; margin:0 auto;
  opacity:0; transform:translateY(40px);
  transition:all 1s cubic-bezier(.16,1,.3,1);
}
.text-section.in-view { opacity:1; transform:translateY(0); }
.text-section p {
  font-size:1.4rem; line-height:1.8; color:rgba(220,200,255,0.8);
  font-style:italic;
}
.text-section .accent {
  color:#c9a0ff; font-weight:600;
}

/* ===== SOUND BANNER ===== */
.sound-banner {
  position:fixed; bottom:20px; left:50%; transform:translateX(-50%);
  z-index:50; padding:12px 28px; border-radius:40px;
  background:rgba(20,15,50,0.85); backdrop-filter:blur(20px);
  border:1px solid rgba(180,140,255,0.2);
  font-size:0.8rem; letter-spacing:0.15em; text-transform:uppercase;
  color:rgba(180,160,240,0.7); cursor:pointer;
  display:flex; align-items:center; gap:10px;
  transition:all 0.4s ease; opacity:0;
  animation:fadeUp 0.8s 3.5s ease forwards;
}
.sound-banner:hover {
  border-color:rgba(180,140,255,0.5);
  box-shadow:0 0 30px rgba(180,140,255,0.15);
}
.sound-bars {
  display:flex; gap:2px; align-items:end; height:14px;
}
.sound-bar {
  width:3px; border-radius:2px;
  background:linear-gradient(to top, #c9a0ff, #ffd700);
  animation:soundBar 0.8s ease-in-out infinite alternate;
}
.sound-bar:nth-child(1) { height:4px; animation-delay:0s; }
.sound-bar:nth-child(2) { height:8px; animation-delay:0.15s; }
.sound-bar:nth-child(3) { height:12px; animation-delay:0.3s; }
.sound-bar:nth-child(4) { height:6px; animation-delay:0.45s; }
.sound-bars.paused .sound-bar { animation-play-state:paused; height:3px !important; }
@keyframes soundBar {
  to { height:14px; }
}

/* ===== PAINT CANVAS ===== */
.paint-section {
  padding:80px 20px; text-align:center;
}
.paint-prompt {
  font-style:italic; font-size:1rem; color:rgba(180,160,240,0.5);
  margin-bottom:20px; letter-spacing:0.1em;
}
.paint-canvas-wrap {
  position:relative; max-width:800px; margin:0 auto;
  border-radius:16px; overflow:hidden;
  box-shadow:0 20px 60px rgba(0,0,0,0.4);
  background:rgba(10,8,30,0.5);
}
.paint-canvas-wrap canvas {
  display:block; width:100%; cursor:crosshair;
  touch-action:none;
}
.paint-tools {
  display:flex; justify-content:center; gap:10px; margin-top:16px;
}
.paint-color {
  width:28px; height:28px; border-radius:50%; cursor:pointer;
  border:2px solid transparent; transition:all 0.3s ease;
}
.paint-color.active { border-color:#fff; transform:scale(1.2); }
.paint-clear {
  padding:6px 16px; border-radius:20px; border:1px solid rgba(180,140,255,0.3);
  background:transparent; color:rgba(180,160,240,0.6);
  font-family:'Cormorant Garamond', serif; font-size:0.8rem;
  letter-spacing:0.1em; cursor:pointer; transition:all 0.3s ease;
}
.paint-clear:hover { border-color:rgba(180,140,255,0.6); color:#c9a0ff; }

/* ===== MESSAGE ===== */
.message-section {
  padding:100px 20px; text-align:center; max-width:700px; margin:0 auto;
  opacity:0; transform:translateY(40px);
  transition:all 1.2s cubic-bezier(.16,1,.3,1);
}
.message-section.in-view { opacity:1; transform:translateY(0); }
.msg-occasion {
  font-size:0.7rem; letter-spacing:0.35em; text-transform:uppercase;
  color:#c9a0ff; margin-bottom:20px;
}
.msg-divider {
  width:60px; height:1px; margin:0 auto 30px;
  background:linear-gradient(to right, transparent, rgba(180,140,255,0.5), rgba(255,215,0,0.3), transparent);
}
.msg-text {
  font-size:1.5rem; line-height:2; color:rgba(220,200,255,0.85);
  font-style:italic; margin-bottom:40px;
}
.msg-from {
  font-size:1rem; color:rgba(180,160,240,0.5);
  letter-spacing:0.15em;
}

/* ===== CONFETTI CANVAS ===== */
.confetti-canvas {
  position:fixed; top:0; left:0; width:100%; height:100%;
  z-index:40; pointer-events:none;
}

/* ===== GIFT REVEAL ===== */
.gift-section {
  padding:80px 20px; text-align:center;
  opacity:0; transform:translateY(40px);
  transition:all 1s cubic-bezier(.16,1,.3,1);
}
.gift-section.in-view { opacity:1; transform:translateY(0); }
.gift-card {
  display:inline-block; padding:40px 60px; border-radius:16px;
  background:linear-gradient(135deg, rgba(30,20,80,0.8), rgba(15,10,50,0.9));
  border:1px solid rgba(180,140,255,0.2);
  box-shadow:0 20px 60px rgba(0,0,0,0.4), 0 0 40px rgba(180,140,255,0.05);
  cursor:pointer; transition:all 0.6s ease;
}
.gift-card:hover {
  transform:translateY(-4px);
  box-shadow:0 30px 80px rgba(0,0,0,0.5), 0 0 60px rgba(180,140,255,0.1);
}
.gift-icon { font-size:2.5rem; margin-bottom:16px; }
.gift-label {
  font-size:0.7rem; letter-spacing:0.3em; text-transform:uppercase;
  color:rgba(180,160,240,0.5); margin-bottom:12px;
}
.gift-amount {
  font-family:'Playfair Display', serif; font-size:2.5rem; font-weight:700;
  background:linear-gradient(135deg, #c9a0ff, #ffd700);
  -webkit-background-clip:text; -webkit-text-fill-color:transparent;
  background-clip:text;
}
.gift-hidden { filter:blur(20px); transition:filter 0.8s ease; }
.gift-revealed { filter:blur(0); }

/* ===== FOOTER ===== */
.lcs-footer {
  text-align:center; padding:60px 20px 40px;
  border-top:1px solid rgba(180,140,255,0.08);
}
.lcs-made-with {
  font-style:italic; font-size:0.75rem;
  color:rgba(180,160,240,0.35); letter-spacing:0.2em;
  text-transform:uppercase; margin-bottom:12px;
}
.lcs-logo {
  font-family:'Playfair Display', serif; font-size:1.1rem; font-weight:700;
  letter-spacing:0.08em; color:#c9a0ff; text-decoration:none;
  transition:color 0.3s ease;
}
.lcs-logo:hover { color:#ffd700; }
.lcs-tagline {
  font-style:italic; font-size:0.72rem;
  color:rgba(180,160,240,0.3); letter-spacing:0.15em; margin-top:8px;
}

/* ===== RESPONSIVE ===== */
@media(max-width:600px) {
  .photo-duo { grid-template-columns:1fr; }
  .hero-name { font-size:clamp(2rem,10vw,3.5rem); }
  .msg-text { font-size:1.2rem; }
}
</style>
</head>
<body>

<!-- ENVELOPE SCREEN -->
<div class="envelope-screen" id="envelope">
  <canvas class="env-stars" id="envStars"></canvas>
  <div class="envelope-wrap" id="envWrap" onclick="openEnvelope()">
    <div class="envelope-body">
      <div class="envelope-flap"></div>
      <div class="envelope-seal">‚ú¶</div>
      <div class="envelope-tagline">written in the stars</div>
    </div>
  </div>
</div>

<!-- UNIVERSE BACKGROUND -->
<canvas class="universe-canvas" id="universe"></canvas>

<!-- SOUND REACTIVE LAYER -->
<canvas class="sound-reactive-layer" id="soundReactive"></canvas>

<!-- CONFETTI -->
<canvas class="confetti-canvas" id="confetti"></canvas>

<!-- SOUND BANNER -->
<div class="sound-banner" id="soundBanner" onclick="toggleSound()">
  <div class="sound-bars" id="soundBars">
    <div class="sound-bar"></div><div class="sound-bar"></div>
    <div class="sound-bar"></div><div class="sound-bar"></div>
  </div>
  <span id="soundLabel">tap for celestial ambience</span>
</div>

<!-- CARD CONTENT -->
<div class="card-content" id="cardContent">

  <!-- HERO -->
  <section class="hero-section">
    <div class="hero-occasion">Happy Birthday</div>
    <h1 class="hero-name">Stella</h1>
    <div class="hero-divider"></div>
    <div class="hero-subtitle">a constellation of love</div>
    <div class="scroll-hint">
      <span>scroll to explore</span>
      <div class="scroll-arrow"></div>
    </div>
  </section>

  <!-- PHOTO 1 ‚Äî Single -->
  <section class="photo-section" data-reveal>
    <div class="photo-frame" data-tilt>
      <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='900' height='600' viewBox='0 0 900 600'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%231a1050'/%3E%3Cstop offset='50%25' style='stop-color:%232d1870'/%3E%3Cstop offset='100%25' style='stop-color:%230d0830'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect fill='url(%23g)' width='900' height='600'/%3E%3Ctext x='450' y='300' text-anchor='middle' fill='rgba(200,180,255,0.3)' font-family='serif' font-size='24'%3EYour Photo Here%3C/text%3E%3C/svg%3E" alt="Photo">
      <div class="photo-overlay"></div>
      <div class="photo-glow"></div>
    </div>
  </section>

  <!-- TEXT -->
  <section class="text-section" data-reveal>
    <p>Every year, you <span class="accent">shine brighter</span> ‚Äî a star that only grows more luminous with time.</p>
  </section>

  <!-- CONSTELLATION DIVIDER -->
  <div class="constellation-divider" data-reveal>
    <canvas id="constDiv1"></canvas>
  </div>

  <!-- PHOTO 2 ‚Äî Duo -->
  <section class="photo-section" data-reveal>
    <div class="photo-duo">
      <div class="photo-frame" data-tilt>
        <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='533' viewBox='0 0 400 533'%3E%3Crect fill='%23150f3a' width='400' height='533'/%3E%3Ctext x='200' y='267' text-anchor='middle' fill='rgba(200,180,255,0.3)' font-family='serif' font-size='18'%3EPhoto 2%3C/text%3E%3C/svg%3E" alt="Photo">
        <div class="photo-overlay"></div>
      </div>
      <div class="photo-frame" data-tilt>
        <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='533' viewBox='0 0 400 533'%3E%3Crect fill='%23150f3a' width='400' height='533'/%3E%3Ctext x='200' y='267' text-anchor='middle' fill='rgba(200,180,255,0.3)' font-family='serif' font-size='18'%3EPhoto 3%3C/text%3E%3C/svg%3E" alt="Photo">
        <div class="photo-overlay"></div>
      </div>
    </div>
  </section>

  <!-- TEXT -->
  <section class="text-section" data-reveal>
    <p>The universe conspired to place you <span class="accent">exactly here</span>, in this moment, surrounded by love.</p>
  </section>

  <!-- PHOTO 3 ‚Äî Single wide -->
  <section class="photo-section" data-reveal>
    <div class="photo-frame" data-tilt>
      <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='900' height='500' viewBox='0 0 900 500'%3E%3Cdefs%3E%3ClinearGradient id='g2' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%23201060'/%3E%3Cstop offset='100%25' style='stop-color:%230a0625'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect fill='url(%23g2)' width='900' height='500'/%3E%3Ctext x='450' y='250' text-anchor='middle' fill='rgba(200,180,255,0.3)' font-family='serif' font-size='24'%3EYour Photo Here%3C/text%3E%3C/svg%3E" alt="Photo">
      <div class="photo-overlay"></div>
      <div class="photo-glow"></div>
    </div>
  </section>

  <!-- PAINT CANVAS -->
  <section class="paint-section" data-reveal>
    <div class="paint-prompt">‚ú¶ paint among the stars ‚ú¶</div>
    <div class="paint-canvas-wrap">
      <canvas id="paintCanvas" width="800" height="500"></canvas>
    </div>
    <div class="paint-tools">
      <div class="paint-color active" style="background:linear-gradient(135deg,#c9a0ff,#a070dd)" data-color="#c9a0ff"></div>
      <div class="paint-color" style="background:linear-gradient(135deg,#ffd700,#daa520)" data-color="#ffd700"></div>
      <div class="paint-color" style="background:linear-gradient(135deg,#70d4ff,#4090c0)" data-color="#70d4ff"></div>
      <div class="paint-color" style="background:linear-gradient(135deg,#ff70b0,#d04080)" data-color="#ff70b0"></div>
      <div class="paint-color" style="background:linear-gradient(135deg,#f0e8ff,#d0c0ee)" data-color="#f0e8ff"></div>
      <button class="paint-clear" onclick="clearPaint()">clear</button>
    </div>
  </section>

  <!-- MESSAGE -->
  <section class="message-section" data-reveal>
    <div class="msg-occasion">Happy Birthday</div>
    <div class="msg-divider"></div>
    <div class="msg-text">
      May this new chapter be written across the most brilliant sky ‚Äî full of wonder, discovery, and all the cosmic magic you deserve.
    </div>
    <div class="msg-from">‚Äî With all my love ‚ú¶</div>
  </section>

  <!-- GIFT REVEAL -->
  <section class="gift-section" data-reveal>
    <div class="gift-card" onclick="revealGift(this)">
      <div class="gift-icon">üéÅ</div>
      <div class="gift-label">a little something for you</div>
      <div class="gift-amount gift-hidden">$50</div>
    </div>
  </section>

  <!-- FOOTER -->
  <footer class="lcs-footer">
    <div class="lcs-made-with">made with love on</div>
    <a href="https://livecardstudio.com" class="lcs-logo">‚ú¶ LiveCardStudio</a>
    <div class="lcs-tagline">cards that live & breathe</div>
  </footer>
</div>

<script>
// ============================================================
// PERLIN NOISE
// ============================================================
const PERLIN = (() => {
  const p = [];
  for(let i=0;i<256;i++) p[i]=i;
  for(let i=255;i>0;i--){ const j=Math.floor(Math.random()*(i+1));[p[i],p[j]]=[p[j],p[i]]; }
  const perm = [...p,...p];
  function fade(t){ return t*t*t*(t*(t*6-15)+10); }
  function lerp(a,b,t){ return a+t*(b-a); }
  function grad(h,x,y,z){
    const e=h&15;
    const u=e<8?x:y, v=e<4?y:e===12||e===14?x:z;
    return((e&1)?-u:u)+((e&2)?-v:v);
  }
  return {
    noise3D(x,y,z){
      const X=Math.floor(x)&255, Y=Math.floor(y)&255, Z=Math.floor(z)&255;
      x-=Math.floor(x); y-=Math.floor(y); z-=Math.floor(z);
      const u=fade(x), v=fade(y), w=fade(z);
      const A=perm[X]+Y, AA=perm[A]+Z, AB=perm[A+1]+Z;
      const B=perm[X+1]+Y, BA=perm[B]+Z, BB=perm[B+1]+Z;
      return lerp(
        lerp(lerp(grad(perm[AA],x,y,z),grad(perm[BA],x-1,y,z),u),
             lerp(grad(perm[AB],x,y-1,z),grad(perm[BB],x-1,y-1,z),u),v),
        lerp(lerp(grad(perm[AA+1],x,y,z-1),grad(perm[BA+1],x-1,y,z-1),u),
             lerp(grad(perm[AB+1],x,y-1,z-1),grad(perm[BB+1],x-1,y-1,z-1),u),v),w);
    },
    fbm(x,y,z,oct=4){
      let v=0,a=0.5,f=1;
      for(let i=0;i<oct;i++){ v+=a*this.noise3D(x*f,y*f,z*f); f*=2; a*=0.5; }
      return v;
    }
  };
})();

// ============================================================
// AI-GENERATED UNIVERSE BACKGROUND
// ============================================================
const uniCanvas = document.getElementById('universe');
const uniCtx = uniCanvas.getContext('2d');
let uniW, uniH;

// Star field
const stars = [];
const STAR_COUNT = 800;
// Nebula noise offset
let nebulaZ = 0;

function initUniverse() {
  uniW = uniCanvas.width = window.innerWidth;
  uniH = uniCanvas.height = window.innerHeight;
  stars.length = 0;
  for(let i=0; i<STAR_COUNT; i++){
    stars.push({
      x: Math.random()*uniW,
      y: Math.random()*uniH,
      r: Math.random()*1.8+0.2,
      twinkleSpeed: Math.random()*0.003+0.001,
      twinkleOffset: Math.random()*Math.PI*2,
      depth: Math.random(), // parallax depth
      hue: Math.random()>0.85 ? (Math.random()>0.5?40:200) : 260 // mostly purple, some gold/blue
    });
  }
}

function renderNebula(t) {
  nebulaZ += 0.0003;
  const imgData = uniCtx.createImageData(uniW, uniH);
  const d = imgData.data;
  // Sample at lower res for performance, then upscale
  const step = 4;
  for(let y=0; y<uniH; y+=step){
    for(let x=0; x<uniW; x+=step){
      const nx = x/uniW*3;
      const ny = y/uniH*3;
      // Layer 1: deep purple nebula
      const n1 = (PERLIN.fbm(nx, ny, nebulaZ, 5)+1)*0.5;
      // Layer 2: gold accents
      const n2 = (PERLIN.fbm(nx+10, ny+10, nebulaZ*0.7, 4)+1)*0.5;
      // Layer 3: blue wisps
      const n3 = (PERLIN.fbm(nx+20, ny+5, nebulaZ*1.2, 3)+1)*0.5;

      const purpleIntensity = Math.pow(n1, 1.5) * 0.4;
      const goldIntensity = Math.pow(n2, 3) * 0.25;
      const blueIntensity = Math.pow(n3, 2.5) * 0.15;

      let r = 5 + purpleIntensity*60 + goldIntensity*180;
      let g = 5 + purpleIntensity*15 + goldIntensity*140 + blueIntensity*40;
      let b = 26 + purpleIntensity*120 + blueIntensity*160;

      // Fill block
      for(let dy=0; dy<step && y+dy<uniH; dy++){
        for(let dx=0; dx<step && x+dx<uniW; dx++){
          const i = ((y+dy)*uniW+(x+dx))*4;
          d[i]=r; d[i+1]=g; d[i+2]=b; d[i+3]=255;
        }
      }
    }
  }
  uniCtx.putImageData(imgData, 0, 0);
}

function renderStars(t) {
  const scrollY = window.scrollY || 0;
  stars.forEach(s => {
    const twinkle = Math.sin(t * s.twinkleSpeed + s.twinkleOffset) * 0.4 + 0.6;
    const parallaxY = s.y - scrollY * s.depth * 0.15;
    const drawY = ((parallaxY % uniH) + uniH) % uniH;
    const alpha = twinkle * (0.5 + s.depth * 0.5);

    uniCtx.beginPath();
    uniCtx.arc(s.x, drawY, s.r * twinkle, 0, Math.PI*2);
    const h = s.hue, sat = s.hue===260?30:60, lit = 70+twinkle*20;
    uniCtx.fillStyle = `hsla(${h},${sat}%,${lit}%,${alpha})`;
    uniCtx.fill();

    // Glow for brighter stars
    if(s.r > 1.2){
      uniCtx.beginPath();
      uniCtx.arc(s.x, drawY, s.r*3, 0, Math.PI*2);
      uniCtx.fillStyle = `hsla(${h},${sat}%,${lit}%,${alpha*0.1})`;
      uniCtx.fill();
    }
  });
}

// Aurora curtains
function renderAurora(t) {
  uniCtx.globalCompositeOperation = 'screen';
  for(let i=0; i<3; i++){
    const yBase = uniH * 0.2 + i*60;
    uniCtx.beginPath();
    uniCtx.moveTo(0, uniH);
    for(let x=0; x<=uniW; x+=8){
      const wave = Math.sin(x*0.003 + t*0.0008 + i*1.5) * 80;
      const noise = PERLIN.noise3D(x*0.002, i*0.5, t*0.0003) * 60;
      const y = yBase + wave + noise;
      uniCtx.lineTo(x, y);
    }
    uniCtx.lineTo(uniW, uniH);
    uniCtx.closePath();
    const grad = uniCtx.createLinearGradient(0, yBase-100, 0, yBase+200);
    const hue = 260 + i*30;
    grad.addColorStop(0, `hsla(${hue},60%,50%,0)`);
    grad.addColorStop(0.3, `hsla(${hue},70%,40%,0.06)`);
    grad.addColorStop(0.6, `hsla(${hue-20},60%,30%,0.04)`);
    grad.addColorStop(1, `hsla(${hue},50%,20%,0)`);
    uniCtx.fillStyle = grad;
    uniCtx.fill();
  }
  _renderAtmos(uniCtx,t);_renderBurst(uniCtx);_renderT3(uniCtx,t);_renderLA(uniCtx,t);uniCtx.globalCompositeOperation = 'source-over';
}

// Shooting stars (rare events)
const shootingStars = [];
function maybeShootingStar(t) {
  if(Math.random() < 0.002 && shootingStars.length < 2){
    shootingStars.push({
      x: Math.random()*uniW, y: Math.random()*uniH*0.4,
      vx: 4+Math.random()*4, vy: 2+Math.random()*2,
      life: 1, decay: 0.015+Math.random()*0.01,
      len: 40+Math.random()*60
    });
  }
  for(let i=shootingStars.length-1; i>=0; i--){
    const s = shootingStars[i];
    s.x += s.vx; s.y += s.vy; s.life -= s.decay;
    if(s.life <= 0){ shootingStars.splice(i,1); continue; }
    uniCtx.beginPath();
    uniCtx.moveTo(s.x, s.y);
    uniCtx.lineTo(s.x - s.vx*s.len/5, s.y - s.vy*s.len/5);
    const grad = uniCtx.createLinearGradient(s.x,s.y,s.x-s.vx*s.len/5,s.y-s.vy*s.len/5);
    grad.addColorStop(0, `rgba(255,240,200,${s.life*0.9})`);
    grad.addColorStop(1, `rgba(180,140,255,0)`);
    uniCtx.strokeStyle = grad;
    uniCtx.lineWidth = 1.5;
    uniCtx.stroke();
  }
}

// Nebula rendered once at lower rate, composited in main loop
let nebulaFrame = null;
let nebulaTimer = 0;

function universeLoop(t) {
  // Re-render nebula every ~2 seconds for evolving feel
  nebulaTimer++;
  if(!nebulaFrame || nebulaTimer > 120){
    renderNebula(t);
    nebulaFrame = uniCtx.getImageData(0,0,uniW,uniH);
    nebulaTimer = 0;
  } else {
    uniCtx.putImageData(nebulaFrame, 0, 0);
  }
  renderStars(t);
  renderAurora(t);
  maybeShootingStar(t);
}

// ============================================================
// SOUND ENGINE ‚Äî Celestial Ambience
// ============================================================
let audioCtx, analyser, analyserData, soundPlaying = false;

function initAudio() {
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  analyser = audioCtx.createAnalyser();
  analyser.fftSize = 256;
  analyserData = new Uint8Array(analyser.frequencyBinCount);

  // Master gain
  const master = audioCtx.createGain();
  master.gain.value = 0.25;
  master.connect(analyser);
  analyser.connect(audioCtx.destination);

  // Celestial pad ‚Äî layered oscillators with slow LFO
  const padFreqs = [110, 164.81, 220, 329.63]; // Am chord tones
  padFreqs.forEach((freq, i) => {
    const osc = audioCtx.createOscillator();
    osc.type = 'sine';
    osc.frequency.value = freq;
    const gain = audioCtx.createGain();
    gain.gain.value = 0.04;

    // Slow tremolo
    const lfo = audioCtx.createOscillator();
    lfo.type = 'sine';
    lfo.frequency.value = 0.15 + i*0.05;
    const lfoGain = audioCtx.createGain();
    lfoGain.gain.value = 0.02;
    lfo.connect(lfoGain);
    lfoGain.connect(gain.gain);
    lfo.start();

    // Slow pitch drift
    const pLfo = audioCtx.createOscillator();
    pLfo.type = 'sine';
    pLfo.frequency.value = 0.03 + i*0.01;
    const pGain = audioCtx.createGain();
    pGain.gain.value = 1.5;
    pLfo.connect(pGain);
    pGain.connect(osc.frequency);
    pLfo.start();

    osc.connect(gain);
    gain.connect(master);
    osc.start();
  });

  // Shimmer layer ‚Äî high filtered noise
  const bufferSize = audioCtx.sampleRate * 2;
  const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
  const data = buffer.getChannelData(0);
  for(let i=0; i<bufferSize; i++) data[i] = (Math.random()*2-1)*0.5;
  const noise = audioCtx.createBufferSource();
  noise.buffer = buffer;
  noise.loop = true;
  const hp = audioCtx.createBiquadFilter();
  hp.type = 'highpass'; hp.frequency.value = 4000; hp.Q.value = 0.5;
  const lp = audioCtx.createBiquadFilter();
  lp.type = 'lowpass'; lp.frequency.value = 8000; lp.Q.value = 0.8;
  const noiseGain = audioCtx.createGain();
  noiseGain.gain.value = 0.015;
  noise.connect(hp); hp.connect(lp); lp.connect(noiseGain); noiseGain.connect(master);
  noise.start();

  // Chime hits ‚Äî random crystalline tones
  function scheduleChime() {
    if(!soundPlaying) return;
    const delay = 3 + Math.random() * 8;
    setTimeout(() => {
      if(!soundPlaying) return;
      const chimeFreq = [523.25, 659.25, 783.99, 1046.5, 1318.5][Math.floor(Math.random()*5)];
      const osc = audioCtx.createOscillator();
      osc.type = 'sine';
      osc.frequency.value = chimeFreq;
      const g = audioCtx.createGain();
      g.gain.setValueAtTime(0.06, audioCtx.currentTime);
      g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 3);
      osc.connect(g); g.connect(master);
      osc.start(); osc.stop(audioCtx.currentTime + 3);
      scheduleChime();
    }, delay * 1000);
  }
  scheduleChime();
}

function toggleSound() {
  if(!soundPlaying) {
    if(!audioCtx) initAudio();
    else audioCtx.resume();
    soundPlaying = true;
    document.getElementById('soundBars').classList.remove('paused');
    document.getElementById('soundLabel').textContent = 'celestial ambience';
  } else {
    audioCtx.suspend();
    soundPlaying = false;
    document.getElementById('soundBars').classList.add('paused');
    document.getElementById('soundLabel').textContent = 'tap for celestial ambience';
  }
}

// ============================================================
// SOUND-REACTIVE LAYER
// ============================================================
const srCanvas = document.getElementById('soundReactive');
const srCtx = srCanvas.getContext('2d');

function initSoundReactive() {
  srCanvas.width = window.innerWidth;
  srCanvas.height = window.innerHeight;
}

function renderSoundReactive(t) {
  srCtx.clearRect(0, 0, srCanvas.width, srCanvas.height);
  if(!soundPlaying || !analyser) return;

  analyser.getByteFrequencyData(analyserData);
  const bass = analyserData.slice(0,4).reduce((a,b)=>a+b,0) / (4*255);
  const mid = analyserData.slice(4,20).reduce((a,b)=>a+b,0) / (16*255);
  const high = analyserData.slice(20,60).reduce((a,b)=>a+b,0) / (40*255);

  // Bass: large slow pulsing orb in center
  const cx = srCanvas.width/2, cy = srCanvas.height/2;
  const bassR = 100 + bass * 300;
  const bassGrad = srCtx.createRadialGradient(cx, cy, 0, cx, cy, bassR);
  bassGrad.addColorStop(0, `rgba(180,140,255,${bass*0.15})`);
  bassGrad.addColorStop(0.5, `rgba(120,80,200,${bass*0.08})`);
  bassGrad.addColorStop(1, 'rgba(80,40,160,0)');
  srCtx.fillStyle = bassGrad;
  srCtx.fillRect(0, 0, srCanvas.width, srCanvas.height);

  // Mid: horizontal wave bands
  srCtx.globalCompositeOperation = 'screen';
  for(let i=0; i<5; i++){
    const y = srCanvas.height * (0.2 + i*0.15);
    srCtx.beginPath();
    for(let x=0; x<srCanvas.width; x+=6){
      const wave = Math.sin(x*0.01 + t*0.002 + i) * mid * 40;
      if(x===0) srCtx.moveTo(x, y+wave);
      else srCtx.lineTo(x, y+wave);
    }
    srCtx.strokeStyle = `hsla(${270+i*15},60%,60%,${mid*0.2})`;
    srCtx.lineWidth = 1+mid*3;
    srCtx.stroke();
  }

  // High: sparkle particles
  for(let i=0; i<Math.floor(high*30); i++){
    const sx = Math.random()*srCanvas.width;
    const sy = Math.random()*srCanvas.height;
    const sr = Math.random()*2+0.5;
    srCtx.beginPath();
    srCtx.arc(sx, sy, sr, 0, Math.PI*2);
    srCtx.fillStyle = `rgba(255,215,0,${high*0.4})`;
    srCtx.fill();
  }
  srCtx.globalCompositeOperation = 'source-over';
}

// ============================================================
// CONSTELLATION DIVIDER ANIMATION
// ============================================================
function initConstellation(canvasEl) {
  const ctx = canvasEl.getContext('2d');
  const rect = canvasEl.parentElement.getBoundingClientRect();
  canvasEl.width = rect.width || window.innerWidth;
  canvasEl.height = 200;
  const nodes = [];
  for(let i=0; i<12; i++){
    nodes.push({
      x: canvasEl.width*0.1 + Math.random()*canvasEl.width*0.8,
      y: 30 + Math.random()*140,
      r: 1+Math.random()*2,
      pulse: Math.random()*Math.PI*2
    });
  }
  // Connect nearby nodes
  const edges = [];
  for(let i=0; i<nodes.length; i++){
    for(let j=i+1; j<nodes.length; j++){
      const dx=nodes[i].x-nodes[j].x, dy=nodes[i].y-nodes[j].y;
      if(Math.sqrt(dx*dx+dy*dy) < 180) edges.push([i,j]);
    }
  }
  return { ctx, nodes, edges, canvas: canvasEl };
}

function renderConstellation(data, t) {
  const { ctx, nodes, edges, canvas } = data;
  ctx.clearRect(0,0,canvas.width,canvas.height);

  // Draw edges
  edges.forEach(([i,j]) => {
    const a = 0.15 + Math.sin(t*0.001+i)*0.1;
    ctx.beginPath();
    ctx.moveTo(nodes[i].x, nodes[i].y);
    ctx.lineTo(nodes[j].x, nodes[j].y);
    ctx.strokeStyle = `rgba(180,140,255,${a})`;
    ctx.lineWidth = 0.5;
    ctx.stroke();
  });

  // Draw nodes
  nodes.forEach((n,i) => {
    const pulse = Math.sin(t*0.002 + n.pulse)*0.3+0.7;
    ctx.beginPath();
    ctx.arc(n.x, n.y, n.r*pulse, 0, Math.PI*2);
    ctx.fillStyle = `rgba(200,180,255,${pulse*0.8})`;
    ctx.fill();
    // Glow
    ctx.beginPath();
    ctx.arc(n.x, n.y, n.r*4, 0, Math.PI*2);
    ctx.fillStyle = `rgba(180,140,255,${pulse*0.08})`;
    ctx.fill();
  });
}

// ============================================================
// INTERACTIVE PAINT CANVAS
// ============================================================
const paintCanvas = document.getElementById('paintCanvas');
const paintCtx = paintCanvas.getContext('2d');
let paintColor = '#c9a0ff';
let isPainting = false;
let lastPaint = null;

// Pre-fill with faint star field
function initPaint() {
  paintCtx.fillStyle = 'rgba(8,6,25,1)';
  paintCtx.fillRect(0,0,800,500);
  for(let i=0; i<100; i++){
    paintCtx.beginPath();
    paintCtx.arc(Math.random()*800, Math.random()*500, Math.random()*1.5, 0, Math.PI*2);
    paintCtx.fillStyle = `rgba(200,180,255,${Math.random()*0.3})`;
    paintCtx.fill();
  }
}

function paintAt(x, y) {
  const rect = paintCanvas.getBoundingClientRect();
  const px = (x - rect.left) * (800/rect.width);
  const py = (y - rect.top) * (500/rect.height);

  if(lastPaint) {
    paintCtx.beginPath();
    paintCtx.moveTo(lastPaint.x, lastPaint.y);
    paintCtx.lineTo(px, py);
    paintCtx.strokeStyle = paintColor;
    paintCtx.lineWidth = 4;
    paintCtx.lineCap = 'round';
    paintCtx.globalAlpha = 0.6;
    paintCtx.stroke();
    paintCtx.globalAlpha = 1;

    // Glow
    paintCtx.beginPath();
    paintCtx.moveTo(lastPaint.x, lastPaint.y);
    paintCtx.lineTo(px, py);
    paintCtx.strokeStyle = paintColor;
    paintCtx.lineWidth = 12;
    paintCtx.globalAlpha = 0.08;
    paintCtx.stroke();
    paintCtx.globalAlpha = 1;
  }

  // Sparkle particles
  for(let i=0; i<3; i++){
    paintCtx.beginPath();
    paintCtx.arc(px+Math.random()*20-10, py+Math.random()*20-10, Math.random()*2, 0, Math.PI*2);
    paintCtx.fillStyle = paintColor;
    paintCtx.globalAlpha = 0.4;
    paintCtx.fill();
    paintCtx.globalAlpha = 1;
  }

  lastPaint = { x: px, y: py };
}

paintCanvas.addEventListener('mousedown', e => { isPainting=true; lastPaint=null; paintAt(e.clientX,e.clientY); });
paintCanvas.addEventListener('mousemove', e => { if(isPainting) paintAt(e.clientX,e.clientY); });
paintCanvas.addEventListener('mouseup', () => { isPainting=false; lastPaint=null; });
paintCanvas.addEventListener('mouseleave', () => { isPainting=false; lastPaint=null; });
paintCanvas.addEventListener('touchstart', e => { e.preventDefault(); isPainting=true; lastPaint=null; paintAt(e.touches[0].clientX,e.touches[0].clientY); }, {passive:false});
paintCanvas.addEventListener('touchmove', e => { e.preventDefault(); if(isPainting) paintAt(e.touches[0].clientX,e.touches[0].clientY); }, {passive:false});
paintCanvas.addEventListener('touchend', () => { isPainting=false; lastPaint=null; });

document.querySelectorAll('.paint-color').forEach(el => {
  el.addEventListener('click', () => {
    document.querySelectorAll('.paint-color').forEach(c => c.classList.remove('active'));
    el.classList.add('active');
    paintColor = el.dataset.color;
  });
});
function clearPaint() { initPaint(); }

// ============================================================
// CONFETTI CANNON
// ============================================================
const confettiCanvas = document.getElementById('confetti');
const confCtx = confettiCanvas.getContext('2d');
const confetti = [];

function initConfetti() {
  confettiCanvas.width = window.innerWidth;
  confettiCanvas.height = window.innerHeight;
}

function fireConfetti() {
  for(let i=0; i<80; i++){
    confetti.push({
      x: confettiCanvas.width/2 + (Math.random()-0.5)*200,
      y: confettiCanvas.height*0.6,
      vx: (Math.random()-0.5)*12,
      vy: -8 - Math.random()*8,
      r: 3+Math.random()*4,
      hue: [260,280,40,200,320][Math.floor(Math.random()*5)],
      rot: Math.random()*Math.PI*2,
      rotSpeed: (Math.random()-0.5)*0.2,
      life: 1, decay: 0.005+Math.random()*0.008
    });
  }
}

function renderConfetti() {
  confCtx.clearRect(0,0,confettiCanvas.width,confettiCanvas.height);
  for(let i=confetti.length-1; i>=0; i--){
    const c = confetti[i];
    c.x += c.vx; c.vy += 0.15; c.y += c.vy;
    c.vx *= 0.99; c.rot += c.rotSpeed; c.life -= c.decay;
    if(c.life<=0){ confetti.splice(i,1); continue; }
    confCtx.save();
    confCtx.translate(c.x, c.y);
    confCtx.rotate(c.rot);
    confCtx.fillStyle = `hsla(${c.hue},70%,65%,${c.life})`;
    confCtx.fillRect(-c.r/2, -c.r/2, c.r, c.r*0.6);
    confCtx.restore();
  }
}

// ============================================================
// GIFT REVEAL
// ============================================================
function revealGift(el) {
  const amount = el.querySelector('.gift-amount');
  amount.classList.remove('gift-hidden');
  amount.classList.add('gift-revealed');
  fireConfetti();
}

// ============================================================
// 3D TILT ON PHOTOS
// ============================================================
document.querySelectorAll('[data-tilt]').forEach(el => {
  el.addEventListener('mousemove', e => {
    const rect = el.getBoundingClientRect();
    const x = (e.clientX - rect.left)/rect.width - 0.5;
    const y = (e.clientY - rect.top)/rect.height - 0.5;
    el.style.transform = `perspective(800px) rotateY(${x*8}deg) rotateX(${-y*8}deg)`;
  });
  el.addEventListener('mouseleave', () => {
    el.style.transform = 'perspective(800px) rotateX(0) rotateY(0)';
  });
});

// ============================================================
// SCROLL REVEAL
// ============================================================
const revealEls = document.querySelectorAll('[data-reveal]');
const observer = new IntersectionObserver(entries => {
  entries.forEach(e => {
    if(e.isIntersecting) e.target.classList.add('in-view');
  });
}, { threshold: 0.15 });
revealEls.forEach(el => observer.observe(el));

// ============================================================
// ENVELOPE STARS
// ============================================================
function initEnvStars() {
  const c = document.getElementById('envStars');
  c.width = window.innerWidth; c.height = window.innerHeight;
  const ctx = c.getContext('2d');
  function draw(t) {
    ctx.clearRect(0,0,c.width,c.height);
    for(let i=0; i<150; i++){
      const x = (i*137.5)%c.width;
      const y = (i*97.3)%c.height;
      const twinkle = Math.sin(t*0.002+i*0.5)*0.3+0.7;
      ctx.beginPath();
      ctx.arc(x, y, twinkle*1.2, 0, Math.PI*2);
      ctx.fillStyle = `rgba(200,180,255,${twinkle*0.4})`;
      ctx.fill();
    }
    if(!document.getElementById('envelope').classList.contains('opened'))
      requestAnimationFrame(draw);
  }
  requestAnimationFrame(draw);
}

// ============================================================
// ENVELOPE OPEN
// ============================================================
function openEnvelope() {
  const wrap = document.getElementById('envWrap');
  const screen = document.getElementById('envelope');
  wrap.classList.add('opening');
  setTimeout(() => {
    screen.classList.add('opened');
    document.getElementById('cardContent').classList.add('visible');
  }, 800);
}

// ============================================================
// CONSTELLATION INIT
// ============================================================
let constData1;

// ============================================================
// MAIN LOOP
// ============================================================
let running = true;


// === SIMPLEX NOISE ENGINE ===
const _SN=(()=>{const p=[151,160,137,91,90,15,131,13,201,95,96,53,194,233,7,225,140,36,103,30,69,142,8,99,37,240,21,10,23,190,6,148,247,120,234,75,0,26,197,62,94,252,219,203,117,35,11,32,57,177,33,88,237,149,56,87,174,20,125,136,171,168,68,175,74,165,71,134,139,48,27,166,77,146,158,231,83,111,229,122,60,211,133,230,220,105,92,41,55,46,245,40,244,102,143,54,65,25,63,161,1,216,80,73,209,76,132,187,208,89,18,169,200,196,135,130,116,188,159,86,164,100,109,198,173,186,3,64,52,217,226,250,124,123,5,202,38,147,118,126,255,82,85,212,207,206,59,227,47,16,58,17,182,189,28,42,223,183,170,213,119,248,152,2,44,154,163,70,221,153,101,155,167,43,172,9,129,22,39,253,19,98,108,110,79,113,224,232,178,185,112,104,218,246,97,228,251,34,242,193,238,210,144,12,191,179,162,241,81,51,145,235,249,14,239,107,49,192,214,31,181,199,106,157,184,84,204,176,115,121,50,45,127,4,150,254,138,236,205,93,222,114,67,29,24,72,243,141,128,195,78,66,215,61,156,180];
const perm=new Uint8Array(512),permMod12=new Uint8Array(512);
for(let i=0;i<512;i++){perm[i]=p[i&255];permMod12[i]=perm[i]%12}
const G2=(3-Math.sqrt(3))/6,G3=1/6;
const grad3=[[1,1,0],[-1,1,0],[1,-1,0],[-1,-1,0],[1,0,1],[-1,0,1],[1,0,-1],[-1,0,-1],[0,1,1],[0,-1,1],[0,1,-1],[0,-1,-1]];
function dot2(g,x,y){return g[0]*x+g[1]*y}
function dot3(g,x,y,z){return g[0]*x+g[1]*y+g[2]*z}
return{
noise2D(x,y){const s=(x+y)*.5*(Math.sqrt(3)-1),i=Math.floor(x+s),j=Math.floor(y+s),tt=(i+j)*G2,X0=i-tt,Y0=j-tt,x0=x-X0,y0=y-Y0;
let i1,j1;if(x0>y0){i1=1;j1=0}else{i1=0;j1=1}
const x1=x0-i1+G2,y1=y0-j1+G2,x2=x0-1+2*G2,y2=y0-1+2*G2,ii=i&255,jj=j&255;
let n0=0,n1=0,n2=0,t0=.5-x0*x0-y0*y0;if(t0>=0){t0*=t0;n0=t0*t0*dot2(grad3[permMod12[ii+perm[jj]]],x0,y0)}
let t1=.5-x1*x1-y1*y1;if(t1>=0){t1*=t1;n1=t1*t1*dot2(grad3[permMod12[ii+i1+perm[jj+j1]]],x1,y1)}
let t2=.5-x2*x2-y2*y2;if(t2>=0){t2*=t2;n2=t2*t2*dot2(grad3[permMod12[ii+1+perm[jj+1]]],x2,y2)}
return 70*(n0+n1+n2)},
noise3D(x,y,z){const s=(x+y+z)/3,i=Math.floor(x+s),j=Math.floor(y+s),k=Math.floor(z+s),tt=(i+j+k)*G3,X0=i-tt,Y0=j-tt,Z0=k-tt,x0=x-X0,y0=y-Y0,z0=z-Z0;
let i1,j1,k1,i2,j2,k2;if(x0>=y0){if(y0>=z0){i1=1;j1=0;k1=0;i2=1;j2=1;k2=0}else if(x0>=z0){i1=1;j1=0;k1=0;i2=1;j2=0;k2=1}else{i1=0;j1=0;k1=1;i2=1;j2=0;k2=1}}else{if(y0<z0){i1=0;j1=0;k1=1;i2=0;j2=1;k2=1}else if(x0<z0){i1=0;j1=1;k1=0;i2=0;j2=1;k2=1}else{i1=0;j1=1;k1=0;i2=1;j2=1;k2=0}}
const x1=x0-i1+G3,y1=y0-j1+G3,z1=z0-k1+G3,x2=x0-i2+2*G3,y2=y0-j2+2*G3,z2=z0-k2+2*G3,x3=x0-1+3*G3,y3=y0-1+3*G3,z3=z0-1+3*G3;
const ii=i&255,jj=j&255,kk=k&255;let n0=0,n1=0,n2=0,n3=0;
let t0=.6-x0*x0-y0*y0-z0*z0;if(t0>=0){t0*=t0;n0=t0*t0*dot3(grad3[permMod12[ii+perm[jj+perm[kk]]]],x0,y0,z0)}
let t1=.6-x1*x1-y1*y1-z1*z1;if(t1>=0){t1*=t1;n1=t1*t1*dot3(grad3[permMod12[ii+i1+perm[jj+j1+perm[kk+k1]]]],x1,y1,z1)}
let t2=.6-x2*x2-y2*y2-z2*z2;if(t2>=0){t2*=t2;n2=t2*t2*dot3(grad3[permMod12[ii+i2+perm[jj+j2+perm[kk+k2]]]],x2,y2,z2)}
let t3=.6-x3*x3-y3*y3-z3*z3;if(t3>=0){t3*=t3;n3=t3*t3*dot3(grad3[permMod12[ii+1+perm[jj+1+perm[kk+1]]]],x3,y3,z3)}
return 32*(n0+n1+n2+n3)}
}})();



// === ANIMATED SHIMMER + VIGNETTE + DOUBLE-TAP EGG ===
let _shimPhase=0;
const _eggP=[];let _lastTap=0;
function _onDoubleTap(ex,ey){const now=Date.now();if(now-_lastTap<350){for(let i=0;i<40;i++){const ang=(i/40)*Math.PI*2;const spd=1+Math.random()*4;const delay=Math.random()*12;_eggP.push({x:ex,y:ey,vx:Math.cos(ang)*spd,vy:Math.sin(ang)*spd,sz:2+Math.random()*4,l:1,d:.003+Math.random()*.005,h:45+Math.random()*40-40/2,delay:delay,born:0})}}
_lastTap=now}
document.addEventListener('click',e=>_onDoubleTap(e.clientX,e.clientY));
document.addEventListener('touchend',e=>{if(e.changedTouches&&e.changedTouches.length)_onDoubleTap(e.changedTouches[0].clientX,e.changedTouches[0].clientY)},{passive:true});
function _renderT3(ctx,t){
// Breathing vignette
_shimPhase+=.008;const vigA=.03+Math.sin(_shimPhase)*.015;
const vig=ctx.createRadialGradient(W/2,H/2,W*.2,W/2,H/2,W*.7);vig.addColorStop(0,'rgba(0,0,0,0)');vig.addColorStop(.7,'rgba(40,30,80,'+(vigA*.5)+')');vig.addColorStop(1,'rgba(40,30,80,'+vigA+')');ctx.fillStyle=vig;ctx.fillRect(0,0,W,H);
// Shimmer spotlight (drifting radial glow)
const sx=W/2+_SN.noise2D(_shimPhase*.3,0)*W*.25;const sy=H/2+_SN.noise2D(0,_shimPhase*.3)*H*.2;
const sg=ctx.createRadialGradient(sx,sy,0,sx,sy,W*.15);sg.addColorStop(0,'rgba(220,180,100,.018)');sg.addColorStop(.5,'rgba(220,180,100,.008)');sg.addColorStop(1,'rgba(220,180,100,0)');ctx.fillStyle=sg;ctx.fillRect(0,0,W,H);
// Double-tap egg particles
for(let i=_eggP.length-1;i>=0;i--){const ep=_eggP[i];ep.born++;if(ep.born<ep.delay)continue;
ep.x+=ep.vx;ep.y+=ep.vy;ep.vx*=.985;ep.vy*=.985;ep.vy+=.015;ep.l-=ep.d;if(ep.l<=0){_eggP.splice(i,1);continue}
const ea=ep.l*.6;ctx.beginPath();ctx.arc(ep.x,ep.y,ep.sz*ep.l,0,Math.PI*2);ctx.fillStyle='hsla('+ep.h+',70%,60%,'+ea+')';ctx.fill();
const eg=ctx.createRadialGradient(ep.x,ep.y,0,ep.x,ep.y,ep.sz*3);eg.addColorStop(0,'hsla('+ep.h+',60%,65%,'+(ea*.15)+')');eg.addColorStop(1,'hsla('+ep.h+',50%,55%,0)');ctx.fillStyle=eg;ctx.beginPath();ctx.arc(ep.x,ep.y,ep.sz*3,0,Math.PI*2);ctx.fill()}
}

// === TAP BURST SYSTEM ===
const _BP=[];
function _onTapBurst(ex,ey){for(let i=0;i<18;i++){const ang=Math.random()*Math.PI*2;const spd=.5+Math.random()*3;_BP.push({x:ex,y:ey,vx:Math.cos(ang)*spd,vy:Math.sin(ang)*spd,sz:1+Math.random()*3,l:1,d:.008+Math.random()*.012,h:45+Math.random()*30-30*.5})}}
document.addEventListener('click',e=>_onTapBurst(e.clientX,e.clientY));
document.addEventListener('touchstart',e=>{if(e.touches.length)_onTapBurst(e.touches[0].clientX,e.touches[0].clientY)},{passive:true});
function _renderBurst(ctx){for(let i=_BP.length-1;i>=0;i--){const bp=_BP[i];bp.x+=bp.vx;bp.y+=bp.vy;bp.vx*=.97;bp.vy*=.97;bp.vy+=.02;bp.l-=bp.d;if(bp.l<=0){_BP.splice(i,1);continue}
ctx.beginPath();ctx.arc(bp.x,bp.y,bp.sz*bp.l,0,Math.PI*2);ctx.fillStyle='hsla('+bp.h+',65%,60%,'+(bp.l*.5)+')';ctx.fill();
const bg=ctx.createRadialGradient(bp.x,bp.y,0,bp.x,bp.y,bp.sz*5);bg.addColorStop(0,'hsla('+bp.h+',60%,60%,'+(bp.l*.08)+')');bg.addColorStop(1,'hsla('+bp.h+',50%,50%,0)');ctx.fillStyle=bg;ctx.beginPath();ctx.arc(bp.x,bp.y,bp.sz*5,0,Math.PI*2);ctx.fill();
}}

// === NOISE FLOW FIELD ATMOSPHERE ===
const _FF={res:25,cols:0,rows:0,field:[],zOff:0};
const _AP=[];const _AP_MAX=120;
function _initFF(){_FF.cols=Math.ceil(W/_FF.res);_FF.rows=Math.ceil(H/_FF.res);_FF.field=new Float32Array(_FF.cols*_FF.rows)}
function _updateFF(t){_FF.zOff+=.0008;for(let r=0;r<_FF.rows;r++)for(let c=0;c<_FF.cols;c++){_FF.field[r*_FF.cols+c]=_SN.noise3D(c*.06,r*.06,_FF.zOff)*Math.PI*4}}
function _getAngle(x,y){const c=Math.floor(x/_FF.res),r=Math.floor(y/_FF.res);if(c<0||c>=_FF.cols||r<0||r>=_FF.rows)return 0;return _FF.field[r*_FF.cols+c]}
function _spawnAP(){while(_AP.length<_AP_MAX)_AP.push({x:Math.random()*W,y:Math.random()*H,px:0,py:0,vx:0,vy:0,life:1,maxL:200+Math.random()*400,age:0,hShift:Math.random()*30,sz:.5+Math.random()*2})}
function _renderAtmos(ctx,t){_updateFF(t);
const pulse=.85+Math.sin(t*.0004)*.15;
for(let i=_AP.length-1;i>=0;i--){const p=_AP[i];p.px=p.x;p.py=p.y;
const a=_getAngle(p.x,p.y);p.vx+=Math.cos(a)*0.25;p.vy+=Math.sin(a)*0.25;
// Mouse interaction
if(_mA){const dx=_mX-p.x,dy=_mY-p.y,d=Math.sqrt(dx*dx+dy*dy);if(d<150&&d>0){const f=(1-d/150)*0.15;p.vx+=(dx/d)*f;p.vy+=(dy/d)*f}}
p.vx*=.96;p.vy*=.96;const spd=Math.sqrt(p.vx*p.vx+p.vy*p.vy);if(spd>3){p.vx=(p.vx/spd)*3;p.vy=(p.vy/spd)*3}
p.x+=p.vx;p.y+=p.vy;p.age++;p.life=1-p.age/p.maxL;
if(p.x<-10)p.x=W+10;if(p.x>W+10)p.x=-10;if(p.y<-10)p.y=H+10;if(p.y>H+10)p.y=-10;
if(p.life<=0){p.x=Math.random()*W;p.y=Math.random()*H;p.px=p.x;p.py=p.y;p.vx=0;p.vy=0;p.life=1;p.age=0;p.maxL=200+Math.random()*400;continue}
// Draw with trail
const al=p.life*0.25*pulse;const h=(45+p.hShift+_gHue)%360;
ctx.strokeStyle='hsla('+h+',50%,65%,'+al+')';ctx.lineWidth=p.sz*p.life;ctx.beginPath();ctx.moveTo(p.px,p.py);ctx.lineTo(p.x,p.y);ctx.stroke();
// Glow dot
if(p.sz>1){ctx.beginPath();ctx.arc(p.x,p.y,p.sz*p.life*.8,0,Math.PI*2);ctx.fillStyle='hsla('+h+',50%,75%,'+(al*.4)+')';ctx.fill()}
}}
_initFF();_spawnAP();

// === LIVING ART ENHANCEMENTS ===
let _mX=0,_mY=0,_mA=false;const _ct=[];let _gHue=0,_rT=0;const _rP=[];
document.addEventListener('mousemove',e=>{_mX=e.clientX;_mY=e.clientY;_mA=true;if(_ct.length<25)_ct.push({x:e.clientX,y:e.clientY,r:1+Math.random()*3,l:1,d:.015+Math.random()*.01})});
document.addEventListener('touchmove',e=>{_mX=e.touches[0].clientX;_mY=e.touches[0].clientY;_mA=true;if(_ct.length<15)_ct.push({x:e.touches[0].clientX,y:e.touches[0].clientY,r:1+Math.random()*3,l:1,d:.015+Math.random()*.01})},{passive:true});
document.addEventListener('mouseleave',()=>{_mA=false});
function _renderLA(ctx,t){_gHue=Math.sin(t*.00003)*20;
for(let i=_ct.length-1;i>=0;i--){const p=_ct[i];p.l-=p.d;p.r*=.98;p.y+=.2;if(p.l<=0){_ct.splice(i,1);continue}
ctx.beginPath();ctx.arc(p.x,p.y,p.r*p.l,0,Math.PI*2);ctx.fillStyle='rgba(220,180,100,'+(p.l*.3)+')';ctx.fill();
const tg=ctx.createRadialGradient(p.x,p.y,0,p.x,p.y,p.r*3);tg.addColorStop(0,'rgba(220,180,100,'+(p.l*.08)+')');tg.addColorStop(1,'rgba(220,180,100,0)');ctx.fillStyle=tg;ctx.beginPath();ctx.arc(p.x,p.y,p.r*3,0,Math.PI*2);ctx.fill()}
if(_mA){const mg=ctx.createRadialGradient(_mX,_mY,0,_mX,_mY,80);mg.addColorStop(0,'rgba(220,180,100,.03)');mg.addColorStop(1,'rgba(220,180,100,0)');ctx.fillStyle=mg;ctx.beginPath();ctx.arc(_mX,_mY,80,0,Math.PI*2);ctx.fill()}
_rT++;if(_rT>600+Math.random()*900){_rT=0;for(let i=0;i<12;i++)_rP.push({x:W*(.2+Math.random()*.6),y:H*(.2+Math.random()*.4),vx:(Math.random()-.5)*.8,vy:(Math.random()-.5)*.8,r:1+Math.random()*3,l:1,d:.005+Math.random()*.008,h:45+Math.random()*40})}
for(let i=_rP.length-1;i>=0;i--){const rp=_rP[i];rp.x+=rp.vx;rp.y+=rp.vy;rp.vx*=.99;rp.vy*=.99;rp.l-=rp.d;if(rp.l<=0){_rP.splice(i,1);continue}
ctx.beginPath();ctx.arc(rp.x,rp.y,rp.r*rp.l,0,Math.PI*2);ctx.fillStyle='hsla('+rp.h+',70%,60%,'+(rp.l*.4)+')';ctx.fill();
const rg=ctx.createRadialGradient(rp.x,rp.y,0,rp.x,rp.y,rp.r*4);rg.addColorStop(0,'hsla('+rp.h+',60%,55%,'+(rp.l*.1)+')');rg.addColorStop(1,'hsla('+rp.h+',50%,45%,0)');ctx.fillStyle=rg;ctx.beginPath();ctx.arc(rp.x,rp.y,rp.r*4,0,Math.PI*2);ctx.fill()}}

function mainLoop(t) {
  if(!running) return;
  universeLoop(t);
  renderSoundReactive(t);
  if(constData1) renderConstellation(constData1, t);
  renderConfetti();
  requestAnimationFrame(mainLoop);
}

// ============================================================
// INIT
// ============================================================
function init() {
  initUniverse();
  initSoundReactive();
  initPaint();
  initConfetti();
  initEnvStars();
  constData1 = initConstellation(document.getElementById('constDiv1'));
  requestAnimationFrame(mainLoop);
}

window.addEventListener('resize', () => {
  initUniverse();
  initSoundReactive();
  initConfetti();
});

init();
</script>
</body>
</html>
