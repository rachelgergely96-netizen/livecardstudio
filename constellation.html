<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Constellation Card ‚Äî LiveCard Studio</title>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,500;0,600&family=DM+Sans:ital,wght@0,300;0,400;0,500;0,600&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --bg: #FDFBF7; --tx: #2A2520; --tx2: #5C554D; --tx3: #8A837B;
      --gold: #C9A96E; --gold2: #B8944E; --mid: #1C1926; --bdr: rgba(0,0,0,.06);
    }
    html { scroll-behavior: smooth; }
    body { background: var(--bg); color: var(--tx); font-family: 'DM Sans', sans-serif; font-weight: 300; min-height: 100vh; -webkit-font-smoothing: antialiased; }

    .constellation-page { max-width: 420px; margin: 0 auto; padding: 24px 20px; min-height: 100vh; display: flex; flex-direction: column; justify-content: center; }
    .constellation-page.view-mode { max-width: 100%; padding: 0; min-height: 100vh; display: block; }

    .back-link { display: inline-flex; align-items: center; gap: 6px; font-size: .7rem; color: var(--tx3); text-decoration: none; margin-bottom: 28px; letter-spacing: .05em; }
    .back-link:hover { color: var(--gold2); }

    h1.constellation-title { font-family: 'Cormorant Garamond', serif; font-size: 1.6rem; font-weight: 300; letter-spacing: .12em; margin-bottom: 8px; color: var(--mid); }
    .constellation-sub { font-size: .78rem; color: var(--tx2); line-height: 1.6; margin-bottom: 24px; }

    .form-block { margin-bottom: 20px; }
    .form-block label { display: block; font-size: .6rem; font-weight: 500; letter-spacing: .12em; text-transform: uppercase; color: var(--tx3); margin-bottom: 8px; }
    .form-block input[type="text"],
    .form-block input[type="url"],
    .form-block textarea {
      width: 100%; padding: 12px 14px; border: 1px solid var(--bdr); border-radius: 12px;
      font-family: 'DM Sans', sans-serif; font-size: .9rem; color: var(--tx); background: #fff;
      transition: border-color .25s, box-shadow .25s;
    }
    .form-block input:focus,
    .form-block textarea:focus { outline: none; border-color: var(--gold); box-shadow: 0 0 0 3px rgba(201,169,110,.12); }
    .form-block textarea { resize: vertical; min-height: 88px; }
    .form-block .char-count { font-size: .6rem; color: var(--tx3); margin-top: 4px; text-align: right; }
    .form-block .char-count.at-limit { color: var(--gold2); }

    .color-presets { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 8px; }
    .color-presets input { position: absolute; opacity: 0; pointer-events: none; }
    .color-presets label {
      width: 40px; height: 40px; border-radius: 50%; cursor: pointer; border: 2px solid transparent;
      transition: transform .2s, border-color .2s; flex-shrink: 0;
    }
    .color-presets label:hover { transform: scale(1.08); }
    .color-presets input:checked + label { border-color: var(--mid); box-shadow: 0 0 0 2px var(--bg); }

    .photo-upload { margin-top: 8px; }
    .photo-upload input[type="file"] { display: none; }
    .photo-upload .photo-btn {
      display: inline-flex; align-items: center; gap: 8px; padding: 10px 18px; border-radius: 24px;
      border: 1px dashed var(--bdr); background: rgba(255,255,255,.6); font-size: .75rem; color: var(--tx2);
      cursor: pointer; transition: all .25s;
    }
    .photo-upload .photo-btn:hover { border-color: var(--gold); color: var(--gold2); background: rgba(201,169,110,.06); }
    .photo-upload .photo-preview { width: 56px; height: 56px; border-radius: 50%; object-fit: cover; margin-top: 10px; border: 2px solid var(--bdr); display: none; }
    .photo-upload .photo-preview.show { display: block; }

    .submit-btn {
      width: 100%; padding: 14px 24px; margin-top: 28px; border-radius: 24px; border: none;
      font-family: 'DM Sans', sans-serif; font-size: .72rem; font-weight: 500; letter-spacing: .12em; text-transform: uppercase;
      color: #fff; background: var(--gold2); cursor: pointer; transition: all .3s;
    }
    .submit-btn:hover { background: var(--gold); transform: translateY(-1px); box-shadow: 0 6px 20px rgba(201,169,110,.25); }
    .submit-btn:disabled { opacity: .6; cursor: not-allowed; transform: none; }

    .confirmation { text-align: center; padding: 32px 20px; }
    .confirmation .star-emoji { font-size: 2rem; margin-bottom: 12px; }
    .confirmation h2 { font-family: 'Cormorant Garamond', serif; font-size: 1.35rem; font-weight: 300; letter-spacing: .08em; color: var(--mid); margin-bottom: 8px; }
    .confirmation p { font-size: .8rem; color: var(--tx2); line-height: 1.7; margin-bottom: 20px; }
    .confirmation .share-link-wrap { background: rgba(0,0,0,.04); border-radius: 12px; padding: 14px 16px; margin-bottom: 16px; text-align: left; }
    .confirmation .share-link-wrap label { font-size: .55rem; letter-spacing: .1em; text-transform: uppercase; color: var(--tx3); }
    .confirmation .share-link { font-size: .7rem; word-break: break-all; color: var(--mid); margin-top: 4px; }
    .confirmation .copy-btn { padding: 8px 20px; border-radius: 20px; border: 1px solid var(--bdr); background: #fff; font-size: .65rem; letter-spacing: .08em; cursor: pointer; color: var(--tx2); }
    .confirmation .copy-btn:hover { border-color: var(--gold); color: var(--gold2); }
    .confirmation .copy-btn.copied { border-color: var(--sage); color: var(--sage); }

    .create-actions { display: flex; flex-direction: column; gap: 12px; margin-top: 24px; }
    .create-actions a { display: block; text-align: center; padding: 12px 20px; border-radius: 24px; font-size: .72rem; font-weight: 500; letter-spacing: .08em; text-decoration: none; transition: all .25s; }
    .create-actions .primary { background: var(--gold2); color: #fff; }
    .create-actions .primary:hover { background: var(--gold); }
    .create-actions .secondary { border: 1px solid var(--bdr); color: var(--tx2); }
    .create-actions .secondary:hover { border-color: var(--gold); color: var(--gold2); }

    .view-toolbar { position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%); z-index: 20; display: flex; gap: 12px; }
    .view-toolbar button {
      padding: 12px 24px; border-radius: 24px; border: 1px solid rgba(255,255,255,.2); background: rgba(20,18,35,.85);
      color: rgba(255,255,255,.9); font-family: 'DM Sans', sans-serif; font-size: .68rem; letter-spacing: .1em; cursor: pointer;
      backdrop-filter: blur(12px); transition: all .25s;
    }
    .view-toolbar button:hover { background: rgba(201,169,110,.3); border-color: rgba(201,169,110,.4); color: #fff; }

    #constellation-view-root { position: relative; width: 100%; min-height: 100vh; background: #0A0A14; }
  </style>
</head>
<body>
  <div id="constellation-app" class="constellation-page"></div>

  <script type="module">
    const MAX_MESSAGE_LEN = 140;
    const STORAGE_PREFIX = 'livecard_constellation_';
    const META_PREFIX = 'livecard_constellation_meta_';

    // Preset colors: id -> hex (stored in entry.color)
    const PRESET_COLORS = [
      { id: 'gold', hex: '#E8D4A8', rgb: [232, 212, 168] },
      { id: 'blush', hex: '#E8B8C8', rgb: [232, 184, 200] },
      { id: 'sky', hex: '#A8C8E8', rgb: [168, 200, 232] },
      { id: 'mint', hex: '#A8E8D0', rgb: [168, 232, 208] },
      { id: 'mauve', hex: '#D0B8E8', rgb: [208, 184, 232] },
    ];

    function getParams() {
      const q = new URLSearchParams(window.location.search);
      return { cardId: q.get('c') || null, view: q.get('view') === '1' || q.get('view') === 'true', recipient: q.get('recipient') || null };
    }

    function generateCardId() {
      return 'c_' + Date.now().toString(36) + '_' + Math.random().toString(36).slice(2, 9);
    }

    function getMeta(cardId) {
      try {
        const raw = localStorage.getItem(META_PREFIX + cardId);
        return raw ? JSON.parse(raw) : null;
      } catch { return null; }
    }

    function setMeta(cardId, meta) {
      localStorage.setItem(META_PREFIX + cardId, JSON.stringify(meta));
    }

    function getEntries(cardId) {
      // TODO: Replace with API call, e.g. Supabase/Firebase fetch entries by cardId
      try {
        const raw = localStorage.getItem(STORAGE_PREFIX + cardId);
        if (!raw) return [];
        const arr = JSON.parse(raw);
        return Array.isArray(arr) ? arr : [];
      } catch { return []; }
    }

    function appendEntry(cardId, entry) {
      // TODO: Replace with API call to persist entry (Supabase/Firebase)
      const entries = getEntries(cardId);
      const newEntry = {
        id: 'star_' + Date.now() + '_' + Math.random().toString(36).slice(2, 8),
        name: entry.name.trim(),
        message: entry.message.trim().slice(0, MAX_MESSAGE_LEN),
        photoDataURL: entry.photoDataURL || null,
        color: entry.color,
        timestamp: Date.now(),
      };
      entries.push(newEntry);
      localStorage.setItem(STORAGE_PREFIX + cardId, JSON.stringify(entries));
      return { entry: newEntry, count: entries.length };
    }

    function renderCreateForm(container) {
      container.innerHTML = `
        <a href="index.html" class="back-link">‚Üê Back to LiveCard Studio</a>
        <h1 class="constellation-title">Create a constellation card</h1>
        <p class="constellation-sub">Set the recipient's name. You'll get a link to share so friends can add their stars.</p>
        <form id="constellation-create-form">
          <div class="form-block">
            <label for="recipient-name">Recipient's name</label>
            <input type="text" id="recipient-name" name="recipientName" placeholder="e.g. Alex" required maxlength="80">
          </div>
          <button type="submit" class="submit-btn">Create card & get share link</button>
        </form>
      `;
      container.querySelector('#constellation-create-form').addEventListener('submit', (e) => {
        e.preventDefault();
        const name = container.querySelector('#recipient-name').value.trim();
        if (!name) return;
        const cardId = generateCardId();
        setMeta(cardId, { recipientName: name, createdAt: Date.now() });
        const contributeUrl = window.location.origin + window.location.pathname + '?c=' + encodeURIComponent(cardId) + '&recipient=' + encodeURIComponent(name);
        const viewUrl = window.location.origin + window.location.pathname + '?c=' + encodeURIComponent(cardId) + '&view=1';
        container.innerHTML = `
          <a href="constellation.html" class="back-link">‚Üê Create another</a>
          <div class="confirmation">
            <div class="star-emoji">‚ú®</div>
            <h2>Your constellation card is ready</h2>
            <p>Share this link so others can add their star. Each person fills in their name, message, and optional photo.</p>
            <div class="share-link-wrap">
              <label>Link for contributors</label>
              <div class="share-link" id="share-link">${contributeUrl}</div>
            </div>
            <button type="button" class="copy-btn" id="copy-contribute">Copy link</button>
            <div class="create-actions" style="margin-top:24px">
              <a href="${viewUrl}" class="primary">View constellation</a>
              <a href="${contributeUrl}" class="secondary">Add your own star</a>
            </div>
          </div>
        `;
        container.querySelector('#copy-contribute').addEventListener('click', () => {
          navigator.clipboard.writeText(contributeUrl).then(() => {
            const btn = container.querySelector('#copy-contribute');
            btn.textContent = 'Copied!'; btn.classList.add('copied');
            setTimeout(() => { btn.textContent = 'Copy link'; btn.classList.remove('copied'); }, 2000);
          });
        });
      });
    }

    function renderContributeForm(container, cardId, recipientName) {
      const meta = getMeta(cardId);
      const name = recipientName || (meta && meta.recipientName) || 'someone special';
      container.innerHTML = `
        <a href="constellation.html?c=${encodeURIComponent(cardId)}&view=1" class="back-link">‚Üê View constellation</a>
        <h1 class="constellation-title">Add your star</h1>
        <p class="constellation-sub">A constellation for <strong>${escapeHtml(name)}</strong>. Leave a short message and pick a color.</p>
        <form id="constellation-contribute-form">
          <div class="form-block">
            <label for="contrib-name">Your name</label>
            <input type="text" id="contrib-name" name="name" placeholder="Your name" required maxlength="60">
          </div>
          <div class="form-block">
            <label for="contrib-msg">Message <span class="char-count" id="char-count">0 / ${MAX_MESSAGE_LEN}</span></label>
            <textarea id="contrib-msg" name="message" placeholder="Short message (140 characters max)" maxlength="${MAX_MESSAGE_LEN}"></textarea>
          </div>
          <div class="form-block">
            <label>Star color</label>
            <div class="color-presets">
              ${PRESET_COLORS.map((p, i) => `
                <input type="radio" name="color" id="color-${p.id}" value="${p.hex}" ${i === 0 ? 'checked' : ''}>
                <label for="color-${p.id}" style="background:${p.hex}" title="${p.id}"></label>
              `).join('')}
            </div>
          </div>
          <div class="form-block">
            <label>Photo (optional)</label>
            <div class="photo-upload">
              <input type="file" id="contrib-photo" accept="image/*" capture="environment">
              <label for="contrib-photo" class="photo-btn">üì∑ Add photo</label>
              <img class="photo-preview" id="photo-preview" alt="">
            </div>
          </div>
          <button type="submit" class="submit-btn" id="submit-contrib">Add my star</button>
        </form>
      `;

      const msgEl = container.querySelector('#contrib-msg');
      const countEl = container.querySelector('#char-count');
      const photoInput = container.querySelector('#contrib-photo');
      const photoPreview = container.querySelector('#photo-preview');
      let photoDataURL = null;

      function updateCount() {
        const n = (msgEl.value || '').length;
        countEl.textContent = `${n} / ${MAX_MESSAGE_LEN}`;
        countEl.classList.toggle('at-limit', n >= MAX_MESSAGE_LEN);
      }
      msgEl.addEventListener('input', updateCount);
      updateCount();

      photoInput.addEventListener('change', (e) => {
        const file = e.target.files && e.target.files[0];
        if (!file || !file.type.startsWith('image/')) return;
        const r = new FileReader();
        r.onload = () => {
          photoDataURL = r.result;
          photoPreview.src = photoDataURL;
          photoPreview.classList.add('show');
        };
        r.readAsDataURL(file);
      });

      container.querySelector('#constellation-contribute-form').addEventListener('submit', (e) => {
        e.preventDefault();
        const nameVal = container.querySelector('#contrib-name').value.trim();
        const messageVal = (container.querySelector('#contrib-msg').value || '').trim().slice(0, MAX_MESSAGE_LEN);
        const colorVal = (container.querySelector('input[name="color"]:checked') || {}).value || PRESET_COLORS[0].hex;
        if (!nameVal) return;
        const { entry, count } = appendEntry(cardId, { name: nameVal, message: messageVal, photoDataURL, color: colorVal });
        container.innerHTML = `
          <div class="confirmation">
            <div class="star-emoji">‚ú®</div>
            <h2>You're star #${count} in the constellation</h2>
            <p>Your message is now part of the sky. Share the link below so more friends can add their stars.</p>
            <div class="share-link-wrap">
              <label>Contributor link</label>
              <div class="share-link" id="share-link">${window.location.href.split('?')[0]}?c=${encodeURIComponent(cardId)}${recipientName ? '&recipient=' + encodeURIComponent(recipientName) : ''}</div>
            </div>
            <button type="button" class="copy-btn" id="copy-link">Copy link</button>
            <a href="constellation.html?c=${encodeURIComponent(cardId)}&view=1" class="submit-btn" style="display:block;margin-top:20px;text-decoration:none;text-align:center">View constellation</a>
          </div>
        `;
        container.querySelector('#copy-link').addEventListener('click', () => {
          const url = window.location.href.split('?')[0] + '?c=' + encodeURIComponent(cardId) + (recipientName ? '&recipient=' + encodeURIComponent(recipientName) : '');
          navigator.clipboard.writeText(url).then(() => {
            const btn = container.querySelector('#copy-link');
            btn.textContent = 'Copied!'; btn.classList.add('copied');
            setTimeout(() => { btn.textContent = 'Copy link'; btn.classList.remove('copied'); }, 2000);
          });
        });
      });
    }

    function escapeHtml(s) {
      const div = document.createElement('div');
      div.textContent = s;
      return div.innerHTML;
    }

    function renderView(container, cardId) {
      container.classList.add('view-mode');
      container.innerHTML = `
        <div id="constellation-view-root"></div>
        <div class="view-toolbar">
          <button type="button" id="constellation-download-btn">Download as image</button>
          <a href="constellation.html?c=${encodeURIComponent(cardId)}" style="padding:12px 24px;border-radius:24px;border:1px solid rgba(255,255,255,.2);background:rgba(20,18,35,.85);color:rgba(255,255,255,.9);font-size:.68rem;letter-spacing:.1em;text-decoration:none;">Add a star</a>
        </div>
      `;
      const viewRoot = document.getElementById('constellation-view-root');
      import('./js/constellation.js').then(({ createConstellationCard }) => {
        const card = createConstellationCard({
          container: viewRoot,
          cardId,
          fullPage: true,
          onReady(api) {
            const btn = document.getElementById('constellation-download-btn');
            if (btn) btn.addEventListener('click', () => api.downloadConstellationAsImage());
          },
        });
        card.init();
      });
    }

    (function main() {
      const app = document.getElementById('constellation-app');
      const { cardId, view, recipient } = getParams();

      if (view && cardId) {
        renderView(app, cardId);
        return;
      }
      if (cardId) {
        const meta = getMeta(cardId);
        if (!meta) {
          app.innerHTML = '<p class="constellation-sub">Card not found. <a href="constellation.html">Create one</a>.</p>';
          return;
        }
        renderContributeForm(app, cardId, recipient || meta.recipientName);
        return;
      }
      renderCreateForm(app);
    })();
  </script>
</body>
</html>
